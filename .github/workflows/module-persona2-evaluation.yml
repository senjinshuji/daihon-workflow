name: module-persona2-evaluation

on:
  workflow_call:
    inputs:
      product_name:
        required: true
        type: string
    outputs:
      evaluation_completed:
        value: ${{ jobs.evaluate.outputs.evaluation_completed }}
      persona_id:
        value: ${{ jobs.evaluate.outputs.persona_id }}
    secrets:
      anthropic_api_key:
        required: true

jobs:
  evaluate:
    runs-on: ubuntu-latest
    outputs:
      evaluation_completed: ${{ steps.evaluate-persona2.outputs.completed }}
      persona_id: "persona2"
    steps:
      - uses: actions/checkout@v3
      - uses: actions/setup-node@v4
        with:
          node-version: '20'
      - run: npm install -g @anthropic-ai/claude-code

      - name: Download required artifacts
        uses: actions/download-artifact@v4
        with:
          path: ./
      
      - name: Organize downloaded artifacts
        run: |
          # Create necessary directories
          mkdir -p "${{ inputs.product_name }}/data" "${{ inputs.product_name }}/artifacts" "${{ inputs.product_name }}/personas"
          
          # Move data files
          if [ -d "${{ inputs.product_name }}-data" ]; then
            cp -r "${{ inputs.product_name }}-data"/* "${{ inputs.product_name }}/data/" 2>/dev/null || true
          fi
          
          # Move criteria
          if [ -d "${{ inputs.product_name }}-criteria" ]; then
            cp -r "${{ inputs.product_name }}-criteria"/* "${{ inputs.product_name }}/artifacts/" 2>/dev/null || true
          fi
          
          # Move personas
          if [ -d "${{ inputs.product_name }}-personas" ]; then
            cp -r "${{ inputs.product_name }}-personas"/* "${{ inputs.product_name }}/personas/" 2>/dev/null || true
          fi
          
          # Move sample scripts (for Phase 2)
          if [ -d "${{ inputs.product_name }}-sample-scripts" ]; then
            cp -r "${{ inputs.product_name }}-sample-scripts"/* "${{ inputs.product_name }}/artifacts/" 2>/dev/null || true
          fi

      - id: evaluate-persona2
        env:
          ANTHROPIC_API_KEY: ${{ secrets.anthropic_api_key }}
        run: |
          cat << 'EOF' > persona2_evaluation_prompt.txt
          ãƒšãƒ«ã‚½ãƒŠ2ã«ã‚ˆã‚‹å°æœ¬è©•ä¾¡ã‚’å®Ÿè¡Œã—ã¦ãã ã•ã„ï¼š
          
          ## è©•ä¾¡è€…ã®è¨­å®š
          {PRODUCT_NAME}/personas/persona2.md ã‚’è©³ç´°ã«èª­ã¿è¾¼ã¿ã€ãƒšãƒ«ã‚½ãƒŠ2ã®äººæ ¼ã«ãªã‚Šãã£ã¦è©•ä¾¡ã—ã¦ãã ã•ã„ã€‚
          
          ## è©•ä¾¡å¯¾è±¡
          {PRODUCT_NAME}/artifacts/sample_scripts_for_evaluation.json ã«å«ã¾ã‚Œã‚‹å…¨ã¦ã®å°æœ¬
          
          ## è©•ä¾¡ãƒ—ãƒ­ã‚»ã‚¹
          1. **äººæ ¼ç†è§£**: persona2.mdã‚’æ·±ãèª­ã¿è¾¼ã¿ã€ãã®äººæ ¼ã®ä¾¡å€¤è¦³ãƒ»æ‚©ã¿ãƒ»æ¬²æ±‚ã‚’ç†è§£
          2. **è©•ä¾¡åŸºæº–ç¢ºèª**: {PRODUCT_NAME}/artifacts/criteria.json ã‚’èª­ã¿è¾¼ã¿ã€è©•ä¾¡è»¸ã¨é‡ã¿ä»˜ã‘ã‚’ç¢ºèª
          3. **å°æœ¬åˆ†æ**: å„å°æœ¬ã‚’ãƒšãƒ«ã‚½ãƒŠ2ã®è¦–ç‚¹ã§è©³ç´°ã«åˆ†æ
          4. **åŸºæº–ã«åŸºã¥ãè©•ä¾¡**: criteria.jsonã§å®šç¾©ã•ã‚ŒãŸè©•ä¾¡è»¸ã§0-100ç‚¹è©•ä¾¡
          5. **é‡ã¿ä»˜ã‘è¨ˆç®—**: criteria.jsonã®é‡ã¿ã‚’é©ç”¨ã—ã¦ç·åˆã‚¹ã‚³ã‚¢ç®—å‡º
          6. **è©³ç´°ç†ç”±**: ãªãœãã®ã‚¹ã‚³ã‚¢ãªã®ã‹ã‚’è©³ç´°ã«èª¬æ˜
          
          ## è©•ä¾¡è¦³ç‚¹ï¼ˆãƒšãƒ«ã‚½ãƒŠ2è¦–ç‚¹ï¼‰
          - ã“ã®ãƒšãƒ«ã‚½ãƒŠã¨ã—ã¦æœ¬å½“ã«é­…åŠ›ã‚’æ„Ÿã˜ã‚‹ã‹
          - ã“ã®ãƒšãƒ«ã‚½ãƒŠã®æ·±å±¤å¿ƒç†ã«éŸ¿ãã‹
          - ã“ã®ãƒšãƒ«ã‚½ãƒŠã®èª²é¡Œè§£æ±ºã«ã¤ãªãŒã‚‹ã‹
          - ã“ã®ãƒšãƒ«ã‚½ãƒŠã®èªçŸ¥ã‚’å¤‰ãˆã‚‹åŠ›ãŒã‚ã‚‹ã‹
          
          ## å‡ºåŠ›ãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆ
          {PRODUCT_NAME}/artifacts/persona2_evaluation.json ã«ä»¥ä¸‹å½¢å¼ã§ä¿å­˜ï¼š
          
          ```json
          {
            "persona_id": "persona2",
            "persona_summary": "ãƒšãƒ«ã‚½ãƒŠ2ã®ç‰¹å¾´ãƒ»ä¾¡å€¤è¦³ãƒ»æ‚©ã¿ã®è¦ç´„",
            "evaluation_timestamp": "YYYY-MM-DDTHH:MM:SS",
            "criteria_used": "criteria.jsonã‹ã‚‰èª­ã¿è¾¼ã‚“ã è©•ä¾¡åŸºæº–ã‚’ãã®ã¾ã¾è¨˜éŒ²",
            "evaluations": {
              "script_id": {
                "å„è©•ä¾¡è»¸": "criteria.jsonã§å®šç¾©ã•ã‚ŒãŸè»¸ã”ã¨ã®ã‚¹ã‚³ã‚¢(0-100ç‚¹)",
                "total_score": "é‡ã¿ä»˜ã‘é©ç”¨å¾Œã®ç·åˆã‚¹ã‚³ã‚¢",
                "evaluation_reason": "ãƒšãƒ«ã‚½ãƒŠ2è¦–ç‚¹ã§ã®è©³ç´°ãªè©•ä¾¡ç†ç”±ã¨æ„Ÿã˜æ–¹"
              }
            },
            "evaluation_metadata": {
              "total_scripts_evaluated": 15,
              "average_score": "è¨ˆç®—ã•ã‚ŒãŸå¹³å‡ã‚¹ã‚³ã‚¢",
              "score_distribution": {
                "high": "80ç‚¹ä»¥ä¸Šã®å°æœ¬æ•°",
                "medium": "60-79ç‚¹ã®å°æœ¬æ•°", 
                "low": "60ç‚¹æœªæº€ã®å°æœ¬æ•°"
              }
            }
          }
          ```
          
          **é‡è¦**: criteria.jsonã§å®šç¾©ã•ã‚ŒãŸè©•ä¾¡è»¸ã¨é‡ã¿ä»˜ã‘ã‚’å¿…ãšä½¿ç”¨ã—ã¦ãã ã•ã„ã€‚
          å›ºå®šã®4è»¸ã§ã¯ãªãã€criteria.jsonã®å†…å®¹ã«å¾“ã£ã¦è©•ä¾¡ã‚’å®Ÿè¡Œã—ã¦ãã ã•ã„ã€‚
          
          ãƒšãƒ«ã‚½ãƒŠ2ã®æ·±å±¤å¿ƒç†ã«åŸºã¥ã„ãŸä¸€è²«æ€§ã®ã‚ã‚‹è©•ä¾¡ã‚’å®Ÿè¡Œã—ã¦ãã ã•ã„ã€‚
          EOF
          
          PROMPT=$(cat persona2_evaluation_prompt.txt)
          PROMPT="${PROMPT//\{PRODUCT_NAME\}/${{ inputs.product_name }}}"
          
          npx @anthropic-ai/claude-code \
            --allowedTools "Read,Write" \
            --max-turns 60 \
            --verbose \
            --permission-mode "acceptEdits" \
            -p "$PROMPT"
          
          # è©•ä¾¡å®Œäº†ç¢ºèª
          RESULTS_FILE="${{ inputs.product_name }}/artifacts/persona2_evaluation.json"
          if [ -f "$RESULTS_FILE" ]; then
            echo "completed=true" >> $GITHUB_OUTPUT
            echo "âœ… ãƒšãƒ«ã‚½ãƒŠ2è©•ä¾¡å®Œäº†"
          else
            echo "completed=false" >> $GITHUB_OUTPUT
            echo "âŒ ãƒšãƒ«ã‚½ãƒŠ2è©•ä¾¡ã«å¤±æ•—ã—ã¾ã—ãŸ"
          fi
      
      - name: Upload evaluation artifact
        if: steps.evaluate-persona2.outputs.completed == 'true'
        uses: actions/upload-artifact@v4
        with:
          name: ${{ inputs.product_name }}-persona2-evaluation
          path: ${{ inputs.product_name }}/artifacts/persona2_evaluation.json
          retention-days: 1
      
      - name: Commit persona2 evaluation results
        if: steps.evaluate-persona2.outputs.completed == 'true'
        run: |
          git config --global user.name "github-actions[bot]"
          git config --global user.email "github-actions[bot]@users.noreply.github.com"
          git add "${{ inputs.product_name }}/artifacts/persona2_evaluation.json"
          git commit -m "ğŸ“Š [${{ inputs.product_name }}] Persona2 evaluation results" || echo "No changes to commit"
          git push || echo "Nothing to push"
