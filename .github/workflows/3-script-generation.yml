name: 3. å°æœ¬ç”Ÿæˆã¨ãƒ•ã‚£ãƒ«ã‚¿ãƒªãƒ³ã‚°

on:
  workflow_dispatch:
    inputs:
      product_name:
        description: 'å•†å“å'
        required: true
        type: string
      loop_number:
        description: 'ãƒ«ãƒ¼ãƒ—å›æ•°ï¼ˆè‡ªå‹•ã‚¤ãƒ³ã‚¯ãƒªãƒ¡ãƒ³ãƒˆï¼‰'
        required: false
        type: string
        default: '1'

permissions:
  contents: write
  pull-requests: write
  actions: write

jobs:
  # Step 1: å°æœ¬ç”Ÿæˆï¼ˆä¸¦åˆ—å®Ÿè¡Œï¼‰
  generate_scripts_writer1:
    uses: ./.github/workflows/module-generate-scripts-writer1.yml
    with:
      product_name: ${{ inputs.product_name }}
      loop_number: ${{ inputs.loop_number }}
    secrets:
      anthropic_api_key: ${{ secrets.ANTHROPIC_API_KEY }}

  generate_scripts_writer2:
    uses: ./.github/workflows/module-generate-scripts-writer2.yml
    with:
      product_name: ${{ inputs.product_name }}
      loop_number: ${{ inputs.loop_number }}
    secrets:
      anthropic_api_key: ${{ secrets.ANTHROPIC_API_KEY }}

  generate_scripts_writer3:
    uses: ./.github/workflows/module-generate-scripts-writer3.yml
    with:
      product_name: ${{ inputs.product_name }}
      loop_number: ${{ inputs.loop_number }}
    secrets:
      anthropic_api_key: ${{ secrets.ANTHROPIC_API_KEY }}

  # Step 2: å°æœ¬è©•ä¾¡ã¨ãƒ•ã‚£ãƒ«ã‚¿ãƒªãƒ³ã‚°
  evaluate_and_filter:
    needs: [generate_scripts_writer1, generate_scripts_writer2, generate_scripts_writer3]
    uses: ./.github/workflows/module-evaluate-and-filter.yml
    with:
      product_name: ${{ inputs.product_name }}
      loop_number: ${{ inputs.loop_number }}
    secrets:
      anthropic_api_key: ${{ secrets.ANTHROPIC_API_KEY }}

  # Step 3: Writerèª¿æ•´ï¼ˆå¿…è¦æ™‚ã®ã¿ï¼‰
  adjust_writers:
    needs: evaluate_and_filter
    if: needs.evaluate_and_filter.outputs.writer_adjustment_needed == 'true'
    runs-on: ubuntu-latest
    outputs:
      adjustment_completed: ${{ steps.adjust.outputs.completed }}
    steps:
      - uses: actions/checkout@v3
      - uses: actions/setup-node@v4
        with:
          node-version: '20'
      - run: npm install -g @anthropic-ai/claude-code
      
      - id: adjust
        env:
          ANTHROPIC_API_KEY: ${{ secrets.ANTHROPIC_API_KEY }}
        run: |
          echo "ğŸ”§ Adjusting writer personalities for ${{ inputs.product_name }}..."
          
          # å¤–éƒ¨ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆãƒ•ã‚¡ã‚¤ãƒ«ã®èª­ã¿è¾¼ã¿
          if [ -f ".github/prompts/generation/generate_writers.txt" ]; then
            PROMPT=$(cat .github/prompts/generation/generate_writers.txt)
          else
            echo "::error::Prompt file not found: .github/prompts/generation/generate_writers.txt"
            exit 1
          fi
          
          # Writerèª¿æ•´æŒ‡ç¤ºã‚’è¿½åŠ 
          cat << 'EOF' > writer_adjustment_instruction.txt
          
          ## Writerèª¿æ•´æŒ‡ç¤º
          
          å‰å›ç”Ÿæˆã•ã‚ŒãŸWriterã®å°æœ¬è©•ä¾¡çµæœã‚’å‚è€ƒã«ã€æ‰¿èªå°æœ¬æ•°ãŒä¸è¶³ã—ã¦ã„ã‚‹Writerã®äººæ ¼ã‚’èª¿æ•´ã—ã¦ãã ã•ã„ï¼š
          
          ### è©•ä¾¡çµæœå‚ç…§
          - {PRODUCT_NAME}/evaluations/averaged_script_evaluation.jsonï¼ˆå¹³å‡è©•ä¾¡çµæœï¼‰
          - {PRODUCT_NAME}/artifacts/filtering_results.jsonï¼ˆãƒ•ã‚£ãƒ«ã‚¿ãƒªãƒ³ã‚°çµæœï¼‰
          
          ### èª¿æ•´æ–¹é‡
          1. **æ‰¿èªå°æœ¬æ•°ãŒ3æœ¬æœªæº€ã®Writer**ã‚’ç‰¹å®š
          2. **è©•ä¾¡ãŒä½ã‹ã£ãŸè¦å› **ã‚’åˆ†æï¼ˆcriteria.jsonã®å„é …ç›®ã‚¹ã‚³ã‚¢ï¼‰
          3. **Writeräººæ ¼ã®å•é¡Œç‚¹**ã‚’ç‰¹å®šï¼ˆã‚­ãƒ£ãƒ©ã‚¯ã‚¿ãƒ¼è¨­å®šãƒ»å£èª¿ãƒ»ã‚¢ãƒ—ãƒ­ãƒ¼ãƒæ–¹æ³•ï¼‰
          4. **ã‚¿ãƒ¼ã‚²ãƒƒãƒˆæ·±å±¤å¿ƒç†ã¨ã®æ•´åˆæ€§**ã‚’å†æ¤œè¨¼
          5. **æ”¹å–„ã•ã‚ŒãŸWriteräººæ ¼**ã‚’å†ç”Ÿæˆ
          
          ### èª¿æ•´å†…å®¹
          - **ã‚­ãƒ£ãƒ©ã‚¯ã‚¿ãƒ¼è¨­å®š**: ã‚ˆã‚Šä¿¡é ¼æ€§ãƒ»å…±æ„Ÿæ€§ã®é«˜ã„äººç‰©åƒ
          - **å£èª¿ãƒ»è¨€è‘‰é£ã„**: ã‚¿ãƒ¼ã‚²ãƒƒãƒˆã«éŸ¿ãè¡¨ç¾æ–¹æ³•
          - **è¨´æ±‚ã‚¢ãƒ—ãƒ­ãƒ¼ãƒ**: æ·±å±¤å¿ƒç†ã«ã‚ˆã‚ŠåŠ¹æœçš„ãªæ‰‹æ³•
          - **æˆ¦ç•¥ãƒ‘ãƒƒã‚±ãƒ¼ã‚¸**: WHO-FMT-USP-ã‚³ãƒ³ã‚»ãƒ—ãƒˆ-ã‚­ãƒ£ãƒƒãƒã‚³ãƒ”ãƒ¼ã®æœ€é©åŒ–
          
          æ—¢å­˜ã®Writerå®šç¾©ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ä¸Šæ›¸ãã—ã¦ã€æ”¹å–„ã•ã‚ŒãŸWriteräººæ ¼ã‚’ç”Ÿæˆã—ã¦ãã ã•ã„ã€‚
          EOF
          
          ADJUSTMENT_INSTRUCTION=$(cat writer_adjustment_instruction.txt)
          FULL_PROMPT="$PROMPT\n\n$ADJUSTMENT_INSTRUCTION"
          FULL_PROMPT="${FULL_PROMPT//\{PRODUCT_NAME\}/${{ inputs.product_name }}}"
          
          npx @anthropic-ai/claude-code \
            --allowedTools "Read,Write" \
            --max-turns 60 \
            --verbose \
            --permission-mode "acceptEdits" \
            -p "$FULL_PROMPT"
          
          # å®Œäº†ç¢ºèª
          if [ -f "${{ inputs.product_name }}/writers/writer1.md" ] && \
             [ -f "${{ inputs.product_name }}/writers/writer2.md" ] && \
             [ -f "${{ inputs.product_name }}/writers/writer3.md" ]; then
            echo "completed=true" >> $GITHUB_OUTPUT
            echo "âœ… Writer adjustment completed"
          else
            echo "completed=false" >> $GITHUB_OUTPUT
            echo "âŒ Writer adjustment failed"
          fi

  # Step 4: å†å®Ÿè¡Œåˆ¤å®šï¼ˆWriterèª¿æ•´å¾Œï¼‰
  trigger_retry:
    needs: [evaluate_and_filter, adjust_writers]
    if: needs.evaluate_and_filter.outputs.writer_adjustment_needed == 'true' && needs.adjust_writers.outputs.adjustment_completed == 'true'
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v3
      
      - name: Check loop limit and trigger retry
        run: |
          echo "ğŸ”„ Checking loop limit and triggering retry if needed..."
          
          # ãƒ«ãƒ¼ãƒ—ç•ªå·ã‚’ã‚¤ãƒ³ã‚¯ãƒªãƒ¡ãƒ³ãƒˆ
          NEXT_LOOP=$((${{ inputs.loop_number }} + 1))
          echo "ğŸ“ˆ Next loop number: $NEXT_LOOP"
          
          # æœ€å¤§ãƒ«ãƒ¼ãƒ—æ•°ã®ãƒã‚§ãƒƒã‚¯ï¼ˆãƒ‡ãƒ•ã‚©ãƒ«ãƒˆ: 10å›ï¼‰
          MAX_LOOPS=10
          if [ $NEXT_LOOP -gt $MAX_LOOPS ]; then
            echo "âš ï¸ Maximum loop limit ($MAX_LOOPS) reached. Stopping iteration."
            echo "ğŸ“Š Please check the approved scripts from all loops in the final report."
            exit 0
          fi
          
          echo "ğŸš€ Triggering Phase 3 retry (Loop $NEXT_LOOP)..."
          
          # GitHub CLIã‚’ä½¿ç”¨ã—ã¦ãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼ã‚’å†å®Ÿè¡Œ
          gh workflow run "3-script-generation.yml" \
            -f product_name="${{ inputs.product_name }}" \
            -f loop_number="$NEXT_LOOP" \
            --repo ${{ github.repository }}
        env:
          GITHUB_TOKEN: ${{ secrets.WORKFLOW_TOKEN }}

  # Step 5: çµæœé›†è¨ˆã¨ã‚³ãƒŸãƒƒãƒˆï¼ˆå¸¸ã«å®Ÿè¡Œï¼‰
  finalize:
    needs: [evaluate_and_filter, adjust_writers]
    if: always()  # å¸¸ã«å®Ÿè¡Œï¼ˆã‚¨ãƒ©ãƒ¼æ™‚ã‚‚å«ã‚€ï¼‰
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v3
      
      - name: Download all artifacts
        uses: actions/download-artifact@v4
        with:
          path: ./artifacts-temp
      
      - name: Organize artifacts into directory structure
        run: |
          echo "ğŸ“ Organizing Phase 3 artifacts for ${{ inputs.product_name }}..."
          
          # Create directory structure if not exists
          mkdir -p "${{ inputs.product_name }}/bulk_scripts/loop_${{ inputs.loop_number }}"
          mkdir -p "${{ inputs.product_name }}/evaluations"
          mkdir -p "${{ inputs.product_name }}/artifacts"
          mkdir -p "${{ inputs.product_name }}/approved_scripts/loop_${{ inputs.loop_number }}"
          
          # Move generated scripts - ã‚¢ãƒ¼ãƒ†ã‚£ãƒ•ã‚¡ã‚¯ãƒˆåã‚’ä¿®æ­£ï¼ˆãƒ«ãƒ¼ãƒ—ç•ªå·ä»˜ãï¼‰
          for writer in 1 2 3; do
            # Writerç”Ÿæˆã‚¹ã‚¯ãƒªãƒ—ãƒˆã®ã‚¢ãƒ¼ãƒ†ã‚£ãƒ•ã‚¡ã‚¯ãƒˆåã«åˆã‚ã›ã‚‹ï¼ˆãƒ«ãƒ¼ãƒ—ç•ªå·ä»˜ãï¼‰
            if [ -d "artifacts-temp/${{ inputs.product_name }}-scripts-writer${writer}-loop${{ inputs.loop_number }}" ]; then
              echo "Found writer${writer} scripts in artifacts-temp/${{ inputs.product_name }}-scripts-writer${writer}-loop${{ inputs.loop_number }}"
              cp -r artifacts-temp/${{ inputs.product_name }}-scripts-writer${writer}-loop${{ inputs.loop_number }}/* "${{ inputs.product_name }}/bulk_scripts/loop_${{ inputs.loop_number }}/" 2>/dev/null || true
            else
              echo "Warning: No scripts found for writer${writer} at artifacts-temp/${{ inputs.product_name }}-scripts-writer${writer}-loop${{ inputs.loop_number }}"
            fi
          done
          
          # Move evaluation results
          if [ -d "artifacts-temp/${{ inputs.product_name }}-evaluation-results" ]; then
            cp -r artifacts-temp/${{ inputs.product_name }}-evaluation-results/* "${{ inputs.product_name }}/evaluations/" 2>/dev/null || true
          fi
          
          # Move filtering results and approved scripts
          if [ -d "artifacts-temp/${{ inputs.product_name }}-filtering-results" ]; then
            # Debug: Show artifact structure
            echo "ğŸ“ Artifact structure:"
            ls -la "artifacts-temp/${{ inputs.product_name }}-filtering-results/"
            
            # Move filtering_results.json to artifacts
            if [ -f "artifacts-temp/${{ inputs.product_name }}-filtering-results/filtering_results.json" ]; then
              cp "artifacts-temp/${{ inputs.product_name }}-filtering-results/filtering_results.json" "${{ inputs.product_name }}/artifacts/" 2>/dev/null || true
            fi
            
            # Move approved scripts - check multiple possible locations
            echo "ğŸ“ Looking for approved scripts..."
            
            # Option 1: Scripts directly in artifact root
            SCRIPTS_FOUND=$(ls -1 "artifacts-temp/${{ inputs.product_name }}-filtering-results/"*.md 2>/dev/null | wc -l)
            if [ "$SCRIPTS_FOUND" -gt 0 ]; then
              echo "Found $SCRIPTS_FOUND scripts in artifact root"
              cp "artifacts-temp/${{ inputs.product_name }}-filtering-results/"*.md "${{ inputs.product_name }}/approved_scripts/loop_${{ inputs.loop_number }}/" 2>/dev/null || true
            fi
            
            # Option 2: Scripts in loop subdirectory
            if [ -d "artifacts-temp/${{ inputs.product_name }}-filtering-results/loop_${{ inputs.loop_number }}" ]; then
              echo "Found scripts in loop_${{ inputs.loop_number }} subdirectory"
              cp -r "artifacts-temp/${{ inputs.product_name }}-filtering-results/loop_${{ inputs.loop_number }}/"* "${{ inputs.product_name }}/approved_scripts/loop_${{ inputs.loop_number }}/" 2>/dev/null || true
            fi
            
            # Count approved scripts after copying
            if [ -d "${{ inputs.product_name }}/approved_scripts/loop_${{ inputs.loop_number }}" ]; then
              APPROVED_COUNT=$(ls -1 "${{ inputs.product_name }}/approved_scripts/loop_${{ inputs.loop_number }}/"*.md 2>/dev/null | wc -l)
              echo "âœ… Total approved scripts in loop_${{ inputs.loop_number }}: $APPROVED_COUNT"
            else
              echo "âš ï¸ No approved scripts directory found"
            fi
          fi
          
          # Clean up temp directory
          rm -rf artifacts-temp
          
          # List created structure
          echo "ğŸ“‚ Phase 3 directory structure:"
          find "${{ inputs.product_name }}/bulk_scripts" -type f | head -10
          find "${{ inputs.product_name }}/evaluations" -type f | head -10
      
      - name: Commit Results
        run: |
          echo "ğŸ’¾ Preparing to commit results..."
          
          # Check what we have before committing
          echo "ğŸ“‚ Checking approved scripts:"
          if [ -d "${{ inputs.product_name }}/approved_scripts/loop_${{ inputs.loop_number }}" ]; then
            APPROVED_COUNT=$(ls -1 "${{ inputs.product_name }}/approved_scripts/loop_${{ inputs.loop_number }}/"*.md 2>/dev/null | wc -l)
            echo "âœ… Found $APPROVED_COUNT approved scripts in loop_${{ inputs.loop_number }}"
            ls -la "${{ inputs.product_name }}/approved_scripts/loop_${{ inputs.loop_number }}/" | head -10
          else
            echo "âš ï¸ No approved scripts directory for loop_${{ inputs.loop_number }}"
          fi
          
          echo "ğŸ“‚ Checking bulk scripts:"
          if [ -d "${{ inputs.product_name }}/bulk_scripts/loop_${{ inputs.loop_number }}" ]; then
            BULK_COUNT=$(ls -1 "${{ inputs.product_name }}/bulk_scripts/loop_${{ inputs.loop_number }}/"*.md 2>/dev/null | wc -l)
            echo "âœ… Found $BULK_COUNT bulk scripts in loop_${{ inputs.loop_number }}"
          fi
          
          # Git configuration
          git config --global user.name "github-actions[bot]"
          git config --global user.email "github-actions[bot]@users.noreply.github.com"
          
          # Add all changes
          git add -A
          
          # Create detailed commit message
          if [ -d "${{ inputs.product_name }}/approved_scripts/loop_${{ inputs.loop_number }}" ]; then
            APPROVED_COUNT=$(ls -1 "${{ inputs.product_name }}/approved_scripts/loop_${{ inputs.loop_number }}/"*.md 2>/dev/null | wc -l)
            git commit -m "ğŸ“ [${{ inputs.product_name }}] Loop ${{ inputs.loop_number }}: å°æœ¬ç”Ÿæˆå®Œäº† (æ‰¿èª: ${APPROVED_COUNT}æœ¬)" || {
              echo "No changes to commit"
            }
          else
            git commit -m "ğŸ“ [${{ inputs.product_name }}] Loop ${{ inputs.loop_number }}: å°æœ¬ç”Ÿæˆã¨ãƒ•ã‚£ãƒ«ã‚¿ãƒªãƒ³ã‚°å®Œäº†" || {
              echo "No changes to commit"
            }
          fi
          
          git push || {
            echo "Nothing to push"
          }
      
      - name: Generate Final Report if completed
        if: needs.evaluate_and_filter.outputs.writer_adjustment_needed == 'false'
        run: |
          echo "ğŸ“Š Generating final report for all loops..."
          pip install pandas numpy
          python .github/scripts/python/generate_final_report.py \
            --product-name "${{ inputs.product_name }}" \
            --output-dir "${{ inputs.product_name }}/reports"
      
      - name: Generate Summary
        run: |
          echo "## ğŸ“ Phase 3 å®Ÿè¡Œå®Œäº†: å°æœ¬ç”Ÿæˆã¨ãƒ•ã‚£ãƒ«ã‚¿ãƒªãƒ³ã‚° (Loop ${{ inputs.loop_number }})" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### ğŸ“Š å®Ÿè¡Œçµæœ" >> $GITHUB_STEP_SUMMARY
          echo "- **ãƒ«ãƒ¼ãƒ—ç•ªå·**: ${{ inputs.loop_number }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Writer1å°æœ¬æ•°**: ${{ needs.generate_scripts_writer1.outputs.scripts_generated }}æœ¬" >> $GITHUB_STEP_SUMMARY
          echo "- **Writer2å°æœ¬æ•°**: ${{ needs.generate_scripts_writer2.outputs.scripts_generated }}æœ¬" >> $GITHUB_STEP_SUMMARY
          echo "- **Writer3å°æœ¬æ•°**: ${{ needs.generate_scripts_writer3.outputs.scripts_generated }}æœ¬" >> $GITHUB_STEP_SUMMARY
          echo "- **æ‰¿èªå°æœ¬æ•°**: ${{ needs.evaluate_and_filter.outputs.approved_count }}æœ¬" >> $GITHUB_STEP_SUMMARY
          echo "- **æ‰¿èªç‡**: ${{ needs.evaluate_and_filter.outputs.approval_rate }}%" >> $GITHUB_STEP_SUMMARY
          echo "- **Writerèª¿æ•´å¿…è¦**: ${{ needs.evaluate_and_filter.outputs.writer_adjustment_needed }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          if [ "${{ needs.evaluate_and_filter.outputs.writer_adjustment_needed }}" = "false" ]; then
            echo "### ğŸ‰ ç›®æ¨™é”æˆï¼" >> $GITHUB_STEP_SUMMARY
            echo "å…¨ã¦ã®Writerã§3æœ¬ä»¥ä¸Šã®æ‰¿èªå°æœ¬ãŒç”Ÿæˆã•ã‚Œã¾ã—ãŸã€‚" >> $GITHUB_STEP_SUMMARY
            echo "æœ€çµ‚ãƒ¬ãƒãƒ¼ãƒˆãŒç”Ÿæˆã•ã‚Œã¾ã—ãŸ: ${{ inputs.product_name }}/reports/approved_scripts_report.md" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "æ‰¿èªæ¸ˆã¿å°æœ¬ã‚’ç¢ºèªã—ã¦åˆ¶ä½œã‚’é–‹å§‹ã—ã¦ãã ã•ã„ã€‚" >> $GITHUB_STEP_SUMMARY
          elif [ "${{ needs.evaluate_and_filter.outputs.writer_adjustment_needed }}" = "true" ]; then
            if [ "${{ needs.adjust_writers.outputs.adjustment_completed }}" = "true" ]; then
              NEXT_LOOP=$((${{ inputs.loop_number }} + 1))
              echo "### ğŸ”„ Writerèª¿æ•´å®Œäº† - Loop $NEXT_LOOP ã‚’å®Ÿè¡Œä¸­" >> $GITHUB_STEP_SUMMARY
              echo "Writeräººæ ¼ã‚’èª¿æ•´ã—ã¾ã—ãŸã€‚æ¬¡ã®ãƒ«ãƒ¼ãƒ—ã‚’é–‹å§‹ã—ã¦ã„ã¾ã™ã€‚" >> $GITHUB_STEP_SUMMARY
            else
              echo "### âŒ Writerèª¿æ•´å¤±æ•—" >> $GITHUB_STEP_SUMMARY
              echo "Writerèª¿æ•´ã«å¤±æ•—ã—ã¾ã—ãŸã€‚æ‰‹å‹•ã§ã®ç¢ºèªãŒå¿…è¦ã§ã™ã€‚" >> $GITHUB_STEP_SUMMARY
            fi
          fi
