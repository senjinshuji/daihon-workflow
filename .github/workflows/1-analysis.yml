name: 1. åˆ†æãƒ»ãƒšãƒ«ã‚½ãƒŠãƒ»ãƒ©ã‚¤ã‚¿ãƒ¼ç”Ÿæˆãƒ•ã‚§ãƒ¼ã‚º

on:
  workflow_dispatch:
    inputs:
      product_name:
        description: 'å•†å“å'
        required: true
        type: string
      sheets_id:
        description: 'Google Sheets ID (ã‚ªãƒ—ã‚·ãƒ§ãƒ³)'
        required: false
        type: string

permissions:
  contents: write
  pull-requests: write
  actions: read

jobs:
  # Step 1: ãƒ‡ãƒ¼ã‚¿å–å¾— (ä¸¦åˆ—å®Ÿè¡Œ)
  fetch_data:
    uses: ./.github/workflows/module-fetch-data.yml
    with:
      product_name: ${{ inputs.product_name }}
      sheets_id: ${{ inputs.sheets_id }}
    secrets:
      google_service_account_json: ${{ secrets.GOOGLE_SERVICE_ACCOUNT_JSON }}
      anthropic_api_key: ${{ secrets.ANTHROPIC_API_KEY }}

  # Step 2: Webæ¤œç´¢ (ä¸¦åˆ—å®Ÿè¡Œ)
  web_search:
    uses: ./.github/workflows/module-web-search.yml
    with:
      product_name: ${{ inputs.product_name }}
    secrets:
      gemini_api_key: ${{ secrets.GEMINI_API_KEY }}
      anthropic_api_key: ${{ secrets.ANTHROPIC_API_KEY }}

  # Step 3: å•†å“åˆ†æ (ãƒ‡ãƒ¼ã‚¿å–å¾—å®Œäº†å¾Œ)
  analyze_product:
    needs: [fetch_data, web_search]
    uses: ./.github/workflows/module-product-analysis.yml
    with:
      product_name: ${{ inputs.product_name }}
    secrets:
      anthropic_api_key: ${{ secrets.ANTHROPIC_API_KEY }}

  # Step 3: ã‚¿ãƒ¼ã‚²ãƒƒãƒˆ1åˆ†æ (å•†å“åˆ†æå®Œäº†å¾Œ)
  analyze_target1:
    needs: analyze_product
    uses: ./.github/workflows/module-target1-analysis.yml
    with:
      product_name: ${{ inputs.product_name }}
    secrets:
      anthropic_api_key: ${{ secrets.ANTHROPIC_API_KEY }}

  # Step 3: ã‚¿ãƒ¼ã‚²ãƒƒãƒˆ2åˆ†æ (å•†å“åˆ†æå®Œäº†å¾Œ)
  analyze_target2:
    needs: analyze_product
    uses: ./.github/workflows/module-target2-analysis.yml
    with:
      product_name: ${{ inputs.product_name }}
    secrets:
      anthropic_api_key: ${{ secrets.ANTHROPIC_API_KEY }}

  # Step 3: ã‚¿ãƒ¼ã‚²ãƒƒãƒˆ3åˆ†æ (å•†å“åˆ†æå®Œäº†å¾Œ)
  analyze_target3:
    needs: analyze_product
    uses: ./.github/workflows/module-target3-analysis.yml
    with:
      product_name: ${{ inputs.product_name }}
    secrets:
      anthropic_api_key: ${{ secrets.ANTHROPIC_API_KEY }}

  # Step 4: ãƒšãƒ«ã‚½ãƒŠç”Ÿæˆ (åˆ†æå®Œäº†å¾Œ)
  generate_personas:
    needs: [analyze_target1, analyze_target2, analyze_target3]
    uses: ./.github/workflows/module-generate-personas.yml
    with:
      product_name: ${{ inputs.product_name }}
    secrets:
      anthropic_api_key: ${{ secrets.ANTHROPIC_API_KEY }}

  # Step 5: ãƒ©ã‚¤ã‚¿ãƒ¼ç”Ÿæˆ (åˆ†æå®Œäº†å¾Œ)
  generate_writers:
    needs: [analyze_target1, analyze_target2, analyze_target3]
    uses: ./.github/workflows/module-generate-writers.yml
    with:
      product_name: ${{ inputs.product_name }}
    secrets:
      anthropic_api_key: ${{ secrets.ANTHROPIC_API_KEY }}

  # Step 6: åˆæœŸè©•ä¾¡åŸºæº–è¨­å®š (ãƒšãƒ«ã‚½ãƒŠãƒ»ãƒ©ã‚¤ã‚¿ãƒ¼å®Œäº†å¾Œ)
  initialize_criteria:
    needs: [generate_personas, generate_writers]
    uses: ./.github/workflows/module-initialize-criteria.yml
    with:
      product_name: ${{ inputs.product_name }}
    secrets:
      anthropic_api_key: ${{ secrets.ANTHROPIC_API_KEY }}

  # Step 7: çµæœé›†è¨ˆã¨ã‚³ãƒŸãƒƒãƒˆ
  finalize:
    needs: [analyze_product, analyze_target1, analyze_target2, analyze_target3, generate_personas, generate_writers, initialize_criteria]
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v3
      
      - name: Commit Phase 1 Results
        run: |
          git config --global user.name "github-actions[bot]"
          git config --global user.email "github-actions[bot]@users.noreply.github.com"
          git add -A
          git commit -m "âœ… [${{ inputs.product_name }}] Phase 1 å®Œäº†: åˆ†æãƒ»ãƒšãƒ«ã‚½ãƒŠãƒ»ãƒ©ã‚¤ã‚¿ãƒ¼ç”Ÿæˆ" || {
            echo "No changes to commit"
          }
          git push || {
            echo "Nothing to push"
          }
      
      - name: Generate Summary
        run: |
          echo "## âœ… Phase 1 å®Œäº†: åˆ†æãƒ»ãƒšãƒ«ã‚½ãƒŠãƒ»ãƒ©ã‚¤ã‚¿ãƒ¼ç”Ÿæˆ" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### ğŸ“Š å®Ÿè¡Œçµæœ" >> $GITHUB_STEP_SUMMARY
          echo "- ãƒ‡ãƒ¼ã‚¿å–å¾—: ${{ needs.fetch_data.outputs.completed }}" >> $GITHUB_STEP_SUMMARY
          echo "- Webæ¤œç´¢: ${{ needs.web_search.outputs.completed }}" >> $GITHUB_STEP_SUMMARY
          echo "- å•†å“åˆ†æ: ${{ needs.analyze_product.outputs.analysis_completed }}" >> $GITHUB_STEP_SUMMARY
          echo "- ã‚¿ãƒ¼ã‚²ãƒƒãƒˆ1åˆ†æ: ${{ needs.analyze_target1.outputs.analysis_completed }}" >> $GITHUB_STEP_SUMMARY
          echo "- ã‚¿ãƒ¼ã‚²ãƒƒãƒˆ2åˆ†æ: ${{ needs.analyze_target2.outputs.analysis_completed }}" >> $GITHUB_STEP_SUMMARY
          echo "- ã‚¿ãƒ¼ã‚²ãƒƒãƒˆ3åˆ†æ: ${{ needs.analyze_target3.outputs.analysis_completed }}" >> $GITHUB_STEP_SUMMARY
          echo "- ãƒšãƒ«ã‚½ãƒŠç”Ÿæˆ: ${{ needs.generate_personas.outputs.personas_generated }}å€‹" >> $GITHUB_STEP_SUMMARY
          echo "- ãƒ©ã‚¤ã‚¿ãƒ¼ç”Ÿæˆ: ${{ needs.generate_writers.outputs.writers_generated }}å€‹" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### ğŸš€ æ¬¡ã®ã‚¹ãƒ†ãƒƒãƒ—" >> $GITHUB_STEP_SUMMARY
          echo "Phase 2ï¼ˆè©•ä¾¡åŸºæº–æœ€é©åŒ–ï¼‰ã‚’å®Ÿè¡Œã—ã¦ãã ã•ã„:" >> $GITHUB_STEP_SUMMARY
          echo '```bash' >> $GITHUB_STEP_SUMMARY
          echo 'gh workflow run 2-criteria-optimization.yml -f product_name=${{ inputs.product_name }}' >> $GITHUB_STEP_SUMMARY
          echo '```' >> $GITHUB_STEP_SUMMARY
      
      - name: Trigger Next Phase
        run: |
          echo "ğŸš€ Phase 2 (è©•ä¾¡åŸºæº–æœ€é©åŒ–) ã‚’è‡ªå‹•èµ·å‹•ã—ã¾ã™..."
          gh workflow run 2-criteria-optimization.yml -f product_name=${{ inputs.product_name }}
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
