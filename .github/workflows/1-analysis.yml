name: 1. 分析・ペルソナ・ライター生成フェーズ

on:
  workflow_dispatch:
    inputs:
      product_name:
        description: '商品名'
        required: true
        type: string
      sheets_id:
        description: 'Google Sheets ID (オプション)'
        required: false
        type: string

permissions:
  contents: write
  pull-requests: write
  actions: read

jobs:
  # Step 1: データ取得 (並列実行)
  fetch_data:
    uses: ./.github/workflows/module-fetch-data.yml
    with:
      product_name: ${{ inputs.product_name }}
      sheets_id: ${{ inputs.sheets_id }}
    secrets:
      google_service_account_json: ${{ secrets.GOOGLE_SERVICE_ACCOUNT_JSON }}
      anthropic_api_key: ${{ secrets.ANTHROPIC_API_KEY }}

  # Step 2: Web検索 (並列実行)
  web_search:
    uses: ./.github/workflows/module-web-search.yml
    with:
      product_name: ${{ inputs.product_name }}
    secrets:
      gemini_api_key: ${{ secrets.GEMINI_API_KEY }}
      anthropic_api_key: ${{ secrets.ANTHROPIC_API_KEY }}

  # Step 3: 商品分析 (データ取得完了後)
  analyze_product:
    needs: [fetch_data, web_search]
    uses: ./.github/workflows/module-product-analysis.yml
    with:
      product_name: ${{ inputs.product_name }}
    secrets:
      anthropic_api_key: ${{ secrets.ANTHROPIC_API_KEY }}

  # Step 3: ターゲット1分析 (商品分析完了後)
  analyze_target1:
    needs: analyze_product
    uses: ./.github/workflows/module-target1-analysis.yml
    with:
      product_name: ${{ inputs.product_name }}
    secrets:
      anthropic_api_key: ${{ secrets.ANTHROPIC_API_KEY }}

  # Step 3: ターゲット2分析 (商品分析完了後)
  analyze_target2:
    needs: analyze_product
    uses: ./.github/workflows/module-target2-analysis.yml
    with:
      product_name: ${{ inputs.product_name }}
    secrets:
      anthropic_api_key: ${{ secrets.ANTHROPIC_API_KEY }}

  # Step 3: ターゲット3分析 (商品分析完了後)
  analyze_target3:
    needs: analyze_product
    uses: ./.github/workflows/module-target3-analysis.yml
    with:
      product_name: ${{ inputs.product_name }}
    secrets:
      anthropic_api_key: ${{ secrets.ANTHROPIC_API_KEY }}

  # Step 4: ペルソナ生成 (分析完了後)
  generate_personas:
    needs: [analyze_target1, analyze_target2, analyze_target3]
    uses: ./.github/workflows/module-generate-personas.yml
    with:
      product_name: ${{ inputs.product_name }}
    secrets:
      anthropic_api_key: ${{ secrets.ANTHROPIC_API_KEY }}

  # Step 5: ライター生成 (分析完了後)
  generate_writers:
    needs: [analyze_target1, analyze_target2, analyze_target3]
    uses: ./.github/workflows/module-generate-writers.yml
    with:
      product_name: ${{ inputs.product_name }}
    secrets:
      anthropic_api_key: ${{ secrets.ANTHROPIC_API_KEY }}

  # Step 6: 初期評価基準設定 (ペルソナ・ライター完了後)
  initialize_criteria:
    needs: [generate_personas, generate_writers]
    uses: ./.github/workflows/module-initialize-criteria.yml
    with:
      product_name: ${{ inputs.product_name }}
    secrets:
      anthropic_api_key: ${{ secrets.ANTHROPIC_API_KEY }}

  # Step 7: 結果集計とコミット
  finalize:
    needs: [analyze_product, analyze_target1, analyze_target2, analyze_target3, generate_personas, generate_writers, initialize_criteria]
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v3
      
      - name: Commit Phase 1 Results
        run: |
          git config --global user.name "github-actions[bot]"
          git config --global user.email "github-actions[bot]@users.noreply.github.com"
          git add -A
          git commit -m "✅ [${{ inputs.product_name }}] Phase 1 完了: 分析・ペルソナ・ライター生成" || {
            echo "No changes to commit"
          }
          git push || {
            echo "Nothing to push"
          }
      
      - name: Generate Summary
        run: |
          echo "## ✅ Phase 1 完了: 分析・ペルソナ・ライター生成" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### 📊 実行結果" >> $GITHUB_STEP_SUMMARY
          echo "- データ取得: ${{ needs.fetch_data.outputs.completed }}" >> $GITHUB_STEP_SUMMARY
          echo "- Web検索: ${{ needs.web_search.outputs.completed }}" >> $GITHUB_STEP_SUMMARY
          echo "- 商品分析: ${{ needs.analyze_product.outputs.analysis_completed }}" >> $GITHUB_STEP_SUMMARY
          echo "- ターゲット1分析: ${{ needs.analyze_target1.outputs.analysis_completed }}" >> $GITHUB_STEP_SUMMARY
          echo "- ターゲット2分析: ${{ needs.analyze_target2.outputs.analysis_completed }}" >> $GITHUB_STEP_SUMMARY
          echo "- ターゲット3分析: ${{ needs.analyze_target3.outputs.analysis_completed }}" >> $GITHUB_STEP_SUMMARY
          echo "- ペルソナ生成: ${{ needs.generate_personas.outputs.personas_generated }}個" >> $GITHUB_STEP_SUMMARY
          echo "- ライター生成: ${{ needs.generate_writers.outputs.writers_generated }}個" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### 🚀 次のステップ" >> $GITHUB_STEP_SUMMARY
          echo "Phase 2（評価基準最適化）を実行してください:" >> $GITHUB_STEP_SUMMARY
          echo '```bash' >> $GITHUB_STEP_SUMMARY
          echo 'gh workflow run 2-criteria-optimization.yml -f product_name=${{ inputs.product_name }}' >> $GITHUB_STEP_SUMMARY
          echo '```' >> $GITHUB_STEP_SUMMARY
      
      - name: Trigger Next Phase
        run: |
          echo "🚀 Phase 2 (評価基準最適化) を自動起動します..."
          gh workflow run 2-criteria-optimization.yml -f product_name=${{ inputs.product_name }}
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
