name: module-web-search

on:
  workflow_call:
    inputs:
      product_name:
        description: 'å•†å“å'
        required: true
        type: string
    outputs:
      completed:
        description: 'å®Œäº†ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹'
        value: ${{ jobs.search.outputs.completed }}
      summary_created:
        description: 'ã‚µãƒžãƒªãƒ¼ä½œæˆã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹'
        value: ${{ jobs.search.outputs.summary_created }}
    secrets:
      gemini_api_key:
        description: 'Google Gemini API Key'
        required: true
      anthropic_api_key:
        description: 'Anthropic API Key'
        required: true

jobs:
  search:
    runs-on: ubuntu-latest
    outputs:
      completed: ${{ steps.web-search.outputs.completed }}
      summary_created: ${{ steps.web-search.outputs.summary_created }}
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v3
      
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
      
      - name: Install Claude Code SDK
        run: npm install -g @anthropic-ai/claude-code
      
      - name: Create artifacts directory
        run: |
          mkdir -p "${{ inputs.product_name }}/artifacts"
          echo "âœ… Created artifacts directory: ${{ inputs.product_name }}/artifacts"
      
      - name: Execute Web Search with Claude Code SDK
        id: web-search
        env:
          ANTHROPIC_API_KEY: ${{ secrets.anthropic_api_key }}
          GEMINI_API_KEY: ${{ secrets.gemini_api_key }}
        run: |
          echo "::group::ðŸ” Executing web search for ${{ inputs.product_name }}"
          
          # ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆã‚’å¤–éƒ¨ãƒ•ã‚¡ã‚¤ãƒ«ã‹ã‚‰èª­ã¿è¾¼ã¿
          if [ -f ".github/prompts/analysis/web_search.txt" ]; then
            PROMPT_TEMPLATE=$(cat .github/prompts/analysis/web_search.txt)
          else
            echo "âš ï¸ Prompt file not found, using inline prompt"
            PROMPT_TEMPLATE="å•†å“ã€Œ{PRODUCT_NAME}ã€ã«é–¢ã™ã‚‹Webæ¤œç´¢ã‚’å®Ÿè¡Œã—ã€
            çµæžœã‚’ {PRODUCT_NAME}/artifacts/web_search_summary.md ã«ä¿å­˜ã—ã¦ãã ã•ã„ã€‚
            
            ä»¥ä¸‹ã®è¦³ç‚¹ã§æ¤œç´¢ã‚’è¡Œã£ã¦ãã ã•ã„ï¼š
            1. å•†å“ãƒ¬ãƒ“ãƒ¥ãƒ¼ã¨è©•åˆ¤
            2. ç‰¹å¾´ã¨ãƒ¡ãƒªãƒƒãƒˆãƒ»ãƒ‡ãƒ¡ãƒªãƒƒãƒˆ
            3. ç«¶åˆå•†å“ã¨ã®æ¯”è¼ƒ
            4. ã‚¿ãƒ¼ã‚²ãƒƒãƒˆå±¤
            5. ãƒžãƒ¼ã‚±ãƒ†ã‚£ãƒ³ã‚°æˆ¦ç•¥
            
            Gemini API ã‚­ãƒ¼ã¯ç’°å¢ƒå¤‰æ•° GEMINI_API_KEY ã«è¨­å®šã•ã‚Œã¦ã„ã¾ã™ã€‚
            å¿…è¦ã«å¿œã˜ã¦ .github/scripts/python/web_search.py ã‚’ä½¿ç”¨ã¾ãŸã¯æ”¹è‰¯ã—ã¦ãã ã•ã„ã€‚
            
            å‡ºåŠ›å½¢å¼:
            - ãƒžãƒ¼ã‚¯ãƒ€ã‚¦ãƒ³å½¢å¼ã§æ§‹é€ åŒ–
            - å„è¦³ç‚¹ã”ã¨ã«ã‚»ã‚¯ã‚·ãƒ§ãƒ³ã‚’åˆ†ã‘ã‚‹
            - é‡è¦ãªç™ºè¦‹ã‚’ç®‡æ¡æ›¸ãã§ã¾ã¨ã‚ã‚‹
            - æœ€å¾Œã«ç·åˆçš„ãªåˆ†æžã‚’å«ã‚ã‚‹"
          fi
          
          # ãƒ—ãƒ¬ãƒ¼ã‚¹ãƒ›ãƒ«ãƒ€ãƒ¼ã‚’ç½®æ›
          PROMPT="${PROMPT_TEMPLATE//\{PRODUCT_NAME\}/${{ inputs.product_name }}}"
          
          echo "ðŸ“ Executing Claude Code SDK..."
          
          # Claude Code SDKã®å®Ÿè¡Œ
          npx @anthropic-ai/claude-code \
            --allowedTools "Read,Write,Bash" \
            --max-turns 35 \
            --verbose \
            --permission-mode "acceptEdits" \
            -p "$PROMPT" || {
              echo "::error::âŒ Claude Code SDK execution failed"
              exit 1
            }
          
          # ç”Ÿæˆã•ã‚ŒãŸãƒ•ã‚¡ã‚¤ãƒ«ã®ç¢ºèª
          echo ""
          echo "ðŸ“‚ Checking generated summary..."
          if [ -f "${{ inputs.product_name }}/artifacts/web_search_summary.md" ]; then
            echo "::notice::âœ… Web search summary created"
            echo "File size: $(ls -lh "${{ inputs.product_name }}/artifacts/web_search_summary.md" | awk '{print $5}')"
            echo "completed=true" >> $GITHUB_OUTPUT
            echo "summary_created=true" >> $GITHUB_OUTPUT
          else
            echo "::warning::âš ï¸ Web search summary not found"
            echo "completed=true" >> $GITHUB_OUTPUT
            echo "summary_created=false" >> $GITHUB_OUTPUT
          fi
          
          echo "::endgroup::"
      
      - name: Upload web search artifacts
        if: steps.web-search.outputs.summary_created == 'true'
        uses: actions/upload-artifact@v3
        with:
          name: ${{ inputs.product_name }}-web-search
          path: ${{ inputs.product_name }}/artifacts/web_search_summary.md
          retention-days: 1