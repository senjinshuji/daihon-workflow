name: module-product-analysis

on:
  workflow_call:
    inputs:
      product_name:
        description: 'å•†å“å'
        required: true
        type: string
    outputs:
      analysis_completed:
        description: 'å•†å“åˆ†æžå®Œäº†ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹'
        value: ${{ jobs.analyze.outputs.analysis_completed }}
    secrets:
      anthropic_api_key:
        description: 'Anthropic API Key'
        required: true

jobs:
  analyze:
    runs-on: ubuntu-latest
    outputs:
      analysis_completed: ${{ steps.analyze.outputs.analysis_completed }}
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v3
      
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
      
      - name: Install Claude Code SDK
        run: npm install -g @anthropic-ai/claude-code
      
      - name: Download data artifacts
        uses: actions/download-artifact@v4
        with:
          name: ${{ inputs.product_name }}-data
          path: ${{ inputs.product_name }}/data/
      
      - name: Download web search artifacts
        uses: actions/download-artifact@v4
        with:
          name: ${{ inputs.product_name }}-web-search
          path: ${{ inputs.product_name }}/artifacts/
        continue-on-error: true
      
      - name: Execute Product Analysis
        id: analyze
        env:
          ANTHROPIC_API_KEY: ${{ secrets.anthropic_api_key }}
        run: |
          echo "::group::ðŸ“ˆ Analyzing product for ${{ inputs.product_name }}"
          
          # å•†å“åˆ†æžãƒ—ãƒ­ãƒ³ãƒ—ãƒˆã®èª­ã¿è¾¼ã¿
          if [ -f ".github/prompts/analysis/analyze_product.txt" ]; then
            PROMPT_PRODUCT=$(cat .github/prompts/analysis/analyze_product.txt)
          else
            echo "::error::Prompt file not found: .github/prompts/analysis/analyze_product.txt"
            exit 1
          fi

          PROMPT_PRODUCT="${PROMPT_PRODUCT//\{PRODUCT_NAME\}/${{ inputs.product_name }}}"

          echo "ðŸ“ Executing Claude Code SDK for product analysis..."

          npx @anthropic-ai/claude-code \
            --allowedTools "Read,Write" \
            --max-turns 40 \
            --verbose \
            --permission-mode "acceptEdits" \
            -p "$PROMPT_PRODUCT" || {
              echo "::error::âŒ Claude Code SDK (product) execution failed"
              exit 1
            }
          
          # ç”Ÿæˆã•ã‚ŒãŸãƒ•ã‚¡ã‚¤ãƒ«ã®ç¢ºèª
          echo ""
          echo "ðŸ“‚ Checking generated product analysis report..."
          
          if [ -f "${{ inputs.product_name }}/artifacts/product_analysis.md" ]; then
            echo "::notice::âœ… Product analysis report created"
            echo "analysis_completed=true" >> $GITHUB_OUTPUT
          else
            echo "::warning::âš ï¸ Product analysis report not found"
            echo "analysis_completed=false" >> $GITHUB_OUTPUT
          fi
          
          echo "::endgroup::"
      
      - name: Upload analysis artifacts
        if: steps.analyze.outputs.analysis_completed == 'true'
        uses: actions/upload-artifact@v4
        with:
          name: ${{ inputs.product_name }}-analysis
          path: |
            ${{ inputs.product_name }}/artifacts/product_analysis.md
          retention-days: 1
