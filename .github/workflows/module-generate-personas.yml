name: module-generate-personas

on:
  workflow_call:
    inputs:
      product_name:
        description: 'ÂïÜÂìÅÂêç'
        required: true
        type: string
    outputs:
      personas_generated:
        description: 'ÁîüÊàê„Åï„Çå„Åü„Éö„É´„ÇΩ„ÉäÊï∞'
        value: ${{ jobs.generate.outputs.personas_generated }}
      completed:
        description: 'ÂÆå‰∫Ü„Çπ„ÉÜ„Éº„Çø„Çπ'
        value: ${{ jobs.generate.outputs.completed }}
    secrets:
      anthropic_api_key:
        description: 'Anthropic API Key'
        required: true

jobs:
  generate:
    runs-on: ubuntu-latest
    outputs:
      personas_generated: ${{ steps.generate-personas.outputs.count }}
      completed: ${{ steps.generate-personas.outputs.completed }}
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v3
      
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
      
      - name: Install Claude Code SDK
        run: npm install -g @anthropic-ai/claude-code
      
      - name: Download all required artifacts
        uses: actions/download-artifact@v3
        with:
          path: ./
      
      - name: Organize downloaded artifacts
        run: |
          # Move artifacts to correct locations
          mkdir -p "${{ inputs.product_name }}/data" "${{ inputs.product_name }}/artifacts"
          if [ -d "${{ inputs.product_name }}-data" ]; then
            cp -r "${{ inputs.product_name }}-data"/* "${{ inputs.product_name }}/data/" 2>/dev/null || true
          fi
          if [ -d "${{ inputs.product_name }}-analysis" ]; then
            cp -r "${{ inputs.product_name }}-analysis"/* "${{ inputs.product_name }}/artifacts/" 2>/dev/null || true
          fi
          for i in 1 2 3; do
            if [ -d "${{ inputs.product_name }}-target${i}" ]; then
              cp -r "${{ inputs.product_name }}-target${i}"/* "${{ inputs.product_name }}/artifacts/" 2>/dev/null || true
            fi
          done
      
      - name: Create personas directory
        run: |
          mkdir -p "${{ inputs.product_name }}/personas"
          echo "‚úÖ Created personas directory: ${{ inputs.product_name }}/personas"
      
      - name: Generate Personas with Claude Code SDK
        id: generate-personas
        env:
          ANTHROPIC_API_KEY: ${{ secrets.anthropic_api_key }}
        run: |
          echo "::group::üë• Generating personas for ${{ inputs.product_name }}"
          
          # „Éó„É≠„É≥„Éó„Éà„ÇíÂ§ñÈÉ®„Éï„Ç°„Ç§„É´„Åã„ÇâË™≠„ÅøËæº„Åø
          if [ -f ".github/prompts/generation/generate_personas.txt" ]; then
            PROMPT_TEMPLATE=$(cat .github/prompts/generation/generate_personas.txt)
          else
            echo "‚ö†Ô∏è Prompt file not found, using inline prompt"
            PROMPT_TEMPLATE="ÂàÜÊûê„É¨„Éù„Éº„Éà„ÇíÂü∫„Å´„ÄÅÂïÜÂìÅ„Äå{PRODUCT_NAME}„Äç„ÅÆ„Éö„É´„ÇΩ„Éä„Çí3„Å§ÁîüÊàê„Åó„Å¶„Åè„Å†„Åï„ÅÑ„ÄÇ
            
            ÂÖ•Âäõ:
            - {PRODUCT_NAME}/artifacts/product_analysis.md
            - {PRODUCT_NAME}/artifacts/market_analysis.md
            
            ÁîüÊàê„Åô„Çã„Éï„Ç°„Ç§„É´:
            
            „Äê„Éö„É´„ÇΩ„Éä3Âêç„Äë{PRODUCT_NAME}/personas/
            - persona1.md: „Éó„É©„Ç§„Éû„É™„Çø„Éº„Ç≤„ÉÉ„ÉàÔºàÂÆüÁî®ÊÄßÈáçË¶ñÔºâ
            - persona2.md: „Ç¢„Éº„É™„Éº„Ç¢„ÉÄ„Éó„Çø„ÉºÔºàÈù©Êñ∞ÊÄßÈáçË¶ñÔºâ
            - persona3.md: „Éû„Çπ„Éû„Éº„Ç±„ÉÉ„ÉàÔºàÂÆâÂÆöÂøóÂêëÔºâ
            
            ÂêÑ„Éö„É´„ÇΩ„Éä„Å´„ÅØ‰ª•‰∏ã„ÇíÂê´„ÇÅ„Çã:
            - „Éá„É¢„Ç∞„É©„Éï„Ç£„ÉÉ„ÇØ/„Çµ„Ç§„Ç≥„Ç∞„É©„Éï„Ç£„ÉÉ„ÇØ
            - ÂïÜÂìÅ„Å∏„ÅÆÊÖãÂ∫¶„Å®ÊúüÂæÖ
            - Â∫ÉÂëäË©ï‰æ°„ÅÆË¶ñÁÇπ
            - Âè∞Êú¨Ë©ï‰æ°„ÅÆÈáç„Åø‰ªò„Åë
            
            Ë©≥Á¥∞„ÅßÂÆüË∑µÁöÑ„Å™‰∫∫Ê†ºÂÆöÁæ©„Çí‰ΩúÊàê„Åó„Å¶„Åè„Å†„Åï„ÅÑ„ÄÇ"
          fi
          
          # „Éó„É¨„Éº„Çπ„Éõ„É´„ÉÄ„Éº„ÇíÁΩÆÊèõ
          PROMPT="${PROMPT_TEMPLATE//\{PRODUCT_NAME\}/${{ inputs.product_name }}}"
          
          echo "üìù Executing Claude Code SDK for persona generation..."
          
          # Claude Code SDK„ÅÆÂÆüË°å
          npx @anthropic-ai/claude-code \
            --allowedTools "Read,Write" \
            --max-turns 40 \
            --verbose \
            --permission-mode "acceptEdits" \
            -p "$PROMPT" || {
              echo "::error::‚ùå Claude Code SDK execution failed"
              exit 1
            }
          
          # ÁîüÊàê„Åï„Çå„Åü„Éö„É´„ÇΩ„ÉäÊï∞„Çí„Ç´„Ç¶„É≥„Éà
          echo ""
          echo "üìÇ Checking generated personas..."
          if [ -d "${{ inputs.product_name }}/personas" ]; then
            PERSONA_COUNT=$(ls -1 "${{ inputs.product_name }}/personas/"*.md 2>/dev/null | wc -l)
            echo "::notice::‚úÖ Generated $PERSONA_COUNT personas"
            ls -la "${{ inputs.product_name }}/personas/"
            
            if [ "$PERSONA_COUNT" -gt 0 ]; then
              echo "count=$PERSONA_COUNT" >> $GITHUB_OUTPUT
              echo "completed=true" >> $GITHUB_OUTPUT
            else
              echo "::error::‚ùå No personas were generated"
              exit 1
            fi
          else
            echo "::error::‚ùå Personas directory not found"
            exit 1
          fi
          
          echo "::endgroup::"