name: module-evaluate-and-filter

on:
  workflow_call:
    inputs:
      product_name:
        required: true
        type: string
    outputs:
      approved_count:
        value: ${{ jobs.filter-scripts.outputs.approved_count }}
      approval_rate:
        value: ${{ jobs.filter-scripts.outputs.approval_rate }}
      writer_adjustment_needed:
        value: ${{ jobs.filter-scripts.outputs.writer_adjustment_needed }}
    secrets:
      anthropic_api_key:
        required: true

jobs:
  # Step 1: ãƒšãƒ«ã‚½ãƒŠè©•ä¾¡ï¼ˆä¸¦åˆ—å®Ÿè¡Œï¼‰
  evaluate-persona1:
    runs-on: ubuntu-latest
    outputs:
      completed: ${{ steps.evaluate.outputs.completed }}
    steps:
      - uses: actions/checkout@v3
      - uses: actions/setup-node@v4
        with:
          node-version: '20'
      - run: npm install -g @anthropic-ai/claude-code
      
      - name: Download required artifacts
        uses: actions/download-artifact@v4
        with:
          path: ./
      
      - name: Organize downloaded artifacts
        run: |
          mkdir -p "${{ inputs.product_name }}/bulk_scripts" "${{ inputs.product_name }}/personas" "${{ inputs.product_name }}/artifacts" "${{ inputs.product_name }}/evaluations"
          
          # Move scripts from all writers
          for writer in writer1 writer2 writer3; do
            if [ -d "${{ inputs.product_name }}-scripts-${writer}" ]; then
              cp -r "${{ inputs.product_name }}-scripts-${writer}"/* "${{ inputs.product_name }}/bulk_scripts/" 2>/dev/null || true
            fi
          done
          
          # Move personas
          if [ -d "${{ inputs.product_name }}-personas" ]; then
            cp -r "${{ inputs.product_name }}-personas"/* "${{ inputs.product_name }}/personas/" 2>/dev/null || true
          fi
          
          # Move criteria
          if [ -d "${{ inputs.product_name }}-criteria" ]; then
            cp -r "${{ inputs.product_name }}-criteria"/* "${{ inputs.product_name }}/artifacts/" 2>/dev/null || true
          fi
          
          # Move approval threshold (from Phase 2)
          if [ -d "${{ inputs.product_name }}-threshold" ]; then
            cp -r "${{ inputs.product_name }}-threshold"/* "${{ inputs.product_name }}/artifacts/" 2>/dev/null || true
          fi
      
      - id: evaluate
        env:
          ANTHROPIC_API_KEY: ${{ secrets.anthropic_api_key }}
        run: |
          cat << 'EOF' > evaluate_persona1_prompt.txt
          ãƒšãƒ«ã‚½ãƒŠ1ã¨ã—ã¦15æœ¬ã®å°æœ¬ã‚’è©•ä¾¡ã—ã¦ãã ã•ã„ï¼š
          
          ## ã‚ãªãŸã®å½¹å‰²
          {PRODUCT_NAME}/personas/persona1.md ã§å®šç¾©ã•ã‚ŒãŸãƒšãƒ«ã‚½ãƒŠ1ã¨ã—ã¦ã€äººæ ¼å®šç¾©ã‚’èª­ã¿è¾¼ã‚“ã§ã‹ã‚‰è©•ä¾¡ã‚’å®Ÿè¡Œã—ã¦ãã ã•ã„ã€‚
          
          ## è©•ä¾¡å¯¾è±¡
          {PRODUCT_NAME}/bulk_scripts/ ã®å…¨å°æœ¬ï¼ˆ15æœ¬ï¼‰
          
          ## è©•ä¾¡åŸºæº–
          {PRODUCT_NAME}/artifacts/criteria.json ã‹ã‚‰è©•ä¾¡è»¸ã¨é‡ã¿ä»˜ã‘ã‚’å‹•çš„ã«èª­ã¿è¾¼ã¿ã€ãã®åŸºæº–ã«å¾“ã£ã¦è©•ä¾¡ã—ã¦ãã ã•ã„ã€‚
          
          ## è©•ä¾¡ãƒ—ãƒ­ã‚»ã‚¹
          1. ãƒšãƒ«ã‚½ãƒŠ1ã®äººæ ¼å®šç¾©ã‚’ç†è§£
          2. criteria.jsonã®è©•ä¾¡åŸºæº–ã‚’ç¢ºèª
          3. å„å°æœ¬ã‚’è©•ä¾¡åŸºæº–ã«å¾“ã£ã¦æ¡ç‚¹ï¼ˆå„é …ç›®10ç‚¹æº€ç‚¹ï¼‰
          4. é‡ã¿ä»˜ã‘ã‚’é©ç”¨ã—ã¦ç·åˆã‚¹ã‚³ã‚¢ã‚’ç®—å‡º
          
          ## å‡ºåŠ›ãƒ•ã‚¡ã‚¤ãƒ«
          {PRODUCT_NAME}/evaluations/persona1_script_evaluation.json
          
          ## å‡ºåŠ›ãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆ
          ```json
          {
            "evaluator": "persona1",
            "evaluation_date": "YYYY-MM-DD HH:MM:SS",
            "criteria_used": {
              "version": 1,
              "weights": {...}
            },
            "script_evaluations": [
              {
                "script_file": "writer1_target1_script_01.md",
                "writer": "writer1",
                "detailed_scores": {
                  "appeal_direction_clarity": {"score": 8, "feedback": "..."},
                  "differentiation_clarity": {"score": 7, "feedback": "..."},
                  ...
                },
                "weighted_score": 79.5,
                "persona_perspective": "ãƒšãƒ«ã‚½ãƒŠ1ã¨ã—ã¦ã®å…·ä½“çš„ãªæ„Ÿæƒ³ãƒ»è©•ä¾¡ç†ç”±"
              },
              ...
            ],
            "summary": {
              "total_scripts": 15,
              "average_score": 75.2,
              "highest_score": 89.1,
              "lowest_score": 62.3
            }
          }
          ```
          
          ãƒšãƒ«ã‚½ãƒŠ1ã®æ·±å±¤å¿ƒç†ç‰¹æ€§ã‚’åæ˜ ã—ãŸè©•ä¾¡ã‚’è¡Œã£ã¦ãã ã•ã„ã€‚
          EOF
          
          PROMPT=$(cat evaluate_persona1_prompt.txt)
          PROMPT="${PROMPT//\{PRODUCT_NAME\}/${{ inputs.product_name }}}"
          
          echo "ğŸ­ Persona1 evaluating scripts for ${{ inputs.product_name }}..."
          
          npx @anthropic-ai/claude-code \
            --allowedTools "Read,Write" \
            --max-turns 40 \
            --verbose \
            --permission-mode "acceptEdits" \
            -p "$PROMPT"
          
          # å®Œäº†ç¢ºèª
          if [ -f "${{ inputs.product_name }}/evaluations/persona1_script_evaluation.json" ]; then
            echo "completed=true" >> $GITHUB_OUTPUT
            echo "âœ… Persona1 evaluation completed"
          else
            echo "completed=false" >> $GITHUB_OUTPUT
            echo "âŒ Persona1 evaluation failed"
          fi
      
      - name: Upload evaluation artifact
        if: steps.evaluate.outputs.completed == 'true'
        uses: actions/upload-artifact@v4
        with:
          name: ${{ inputs.product_name }}-persona1-script-eval
          path: ${{ inputs.product_name }}/evaluations/persona1_script_evaluation.json
          retention-days: 1

  evaluate-persona2:
    runs-on: ubuntu-latest
    outputs:
      completed: ${{ steps.evaluate.outputs.completed }}
    steps:
      - uses: actions/checkout@v3
      - uses: actions/setup-node@v4
        with:
          node-version: '20'
      - run: npm install -g @anthropic-ai/claude-code
      
      - name: Download required artifacts
        uses: actions/download-artifact@v4
        with:
          path: ./
      
      - name: Organize downloaded artifacts
        run: |
          mkdir -p "${{ inputs.product_name }}/bulk_scripts" "${{ inputs.product_name }}/personas" "${{ inputs.product_name }}/artifacts" "${{ inputs.product_name }}/evaluations"
          
          # Move scripts from all writers
          for writer in writer1 writer2 writer3; do
            if [ -d "${{ inputs.product_name }}-scripts-${writer}" ]; then
              cp -r "${{ inputs.product_name }}-scripts-${writer}"/* "${{ inputs.product_name }}/bulk_scripts/" 2>/dev/null || true
            fi
          done
          
          # Move personas
          if [ -d "${{ inputs.product_name }}-personas" ]; then
            cp -r "${{ inputs.product_name }}-personas"/* "${{ inputs.product_name }}/personas/" 2>/dev/null || true
          fi
          
          # Move criteria
          if [ -d "${{ inputs.product_name }}-criteria" ]; then
            cp -r "${{ inputs.product_name }}-criteria"/* "${{ inputs.product_name }}/artifacts/" 2>/dev/null || true
          fi
          
          # Move approval threshold (from Phase 2)
          if [ -d "${{ inputs.product_name }}-threshold" ]; then
            cp -r "${{ inputs.product_name }}-threshold"/* "${{ inputs.product_name }}/artifacts/" 2>/dev/null || true
          fi
      
      - id: evaluate
        env:
          ANTHROPIC_API_KEY: ${{ secrets.anthropic_api_key }}
        run: |
          cat << 'EOF' > evaluate_persona2_prompt.txt
          ãƒšãƒ«ã‚½ãƒŠ2ã¨ã—ã¦15æœ¬ã®å°æœ¬ã‚’è©•ä¾¡ã—ã¦ãã ã•ã„ï¼š
          
          ## ã‚ãªãŸã®å½¹å‰²
          {PRODUCT_NAME}/personas/persona2.md ã§å®šç¾©ã•ã‚ŒãŸãƒšãƒ«ã‚½ãƒŠ2ã¨ã—ã¦ã€äººæ ¼å®šç¾©ã‚’èª­ã¿è¾¼ã‚“ã§ã‹ã‚‰è©•ä¾¡ã‚’å®Ÿè¡Œã—ã¦ãã ã•ã„ã€‚
          
          ## è©•ä¾¡å¯¾è±¡
          {PRODUCT_NAME}/bulk_scripts/ ã®å…¨å°æœ¬ï¼ˆ15æœ¬ï¼‰
          
          ## è©•ä¾¡åŸºæº–
          {PRODUCT_NAME}/artifacts/criteria.json ã‹ã‚‰è©•ä¾¡è»¸ã¨é‡ã¿ä»˜ã‘ã‚’å‹•çš„ã«èª­ã¿è¾¼ã¿ã€ãã®åŸºæº–ã«å¾“ã£ã¦è©•ä¾¡ã—ã¦ãã ã•ã„ã€‚
          
          ## è©•ä¾¡ãƒ—ãƒ­ã‚»ã‚¹
          1. ãƒšãƒ«ã‚½ãƒŠ2ã®äººæ ¼å®šç¾©ã‚’ç†è§£
          2. criteria.jsonã®è©•ä¾¡åŸºæº–ã‚’ç¢ºèª
          3. å„å°æœ¬ã‚’è©•ä¾¡åŸºæº–ã«å¾“ã£ã¦æ¡ç‚¹ï¼ˆå„é …ç›®10ç‚¹æº€ç‚¹ï¼‰
          4. é‡ã¿ä»˜ã‘ã‚’é©ç”¨ã—ã¦ç·åˆã‚¹ã‚³ã‚¢ã‚’ç®—å‡º
          
          ## å‡ºåŠ›ãƒ•ã‚¡ã‚¤ãƒ«
          {PRODUCT_NAME}/evaluations/persona2_script_evaluation.json
          
          ## å‡ºåŠ›ãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆ
          ```json
          {
            "evaluator": "persona2",
            "evaluation_date": "YYYY-MM-DD HH:MM:SS",
            "criteria_used": {
              "version": 1,
              "weights": {...}
            },
            "script_evaluations": [
              {
                "script_file": "writer1_target1_script_01.md",
                "writer": "writer1",
                "detailed_scores": {
                  "appeal_direction_clarity": {"score": 8, "feedback": "..."},
                  "differentiation_clarity": {"score": 7, "feedback": "..."},
                  ...
                },
                "weighted_score": 79.5,
                "persona_perspective": "ãƒšãƒ«ã‚½ãƒŠ2ã¨ã—ã¦ã®å…·ä½“çš„ãªæ„Ÿæƒ³ãƒ»è©•ä¾¡ç†ç”±"
              },
              ...
            ],
            "summary": {
              "total_scripts": 15,
              "average_score": 75.2,
              "highest_score": 89.1,
              "lowest_score": 62.3
            }
          }
          ```
          
          ãƒšãƒ«ã‚½ãƒŠ2ã®æ·±å±¤å¿ƒç†ç‰¹æ€§ã‚’åæ˜ ã—ãŸè©•ä¾¡ã‚’è¡Œã£ã¦ãã ã•ã„ã€‚
          EOF
          
          PROMPT=$(cat evaluate_persona2_prompt.txt)
          PROMPT="${PROMPT//\{PRODUCT_NAME\}/${{ inputs.product_name }}}"
          
          echo "ğŸ­ Persona2 evaluating scripts for ${{ inputs.product_name }}..."
          
          npx @anthropic-ai/claude-code \
            --allowedTools "Read,Write" \
            --max-turns 40 \
            --verbose \
            --permission-mode "acceptEdits" \
            -p "$PROMPT"
          
          # å®Œäº†ç¢ºèª
          if [ -f "${{ inputs.product_name }}/evaluations/persona2_script_evaluation.json" ]; then
            echo "completed=true" >> $GITHUB_OUTPUT
            echo "âœ… Persona2 evaluation completed"
          else
            echo "completed=false" >> $GITHUB_OUTPUT
            echo "âŒ Persona2 evaluation failed"
          fi
      
      - name: Upload evaluation artifact
        if: steps.evaluate.outputs.completed == 'true'
        uses: actions/upload-artifact@v4
        with:
          name: ${{ inputs.product_name }}-persona2-script-eval
          path: ${{ inputs.product_name }}/evaluations/persona2_script_evaluation.json
          retention-days: 1

  evaluate-persona3:
    runs-on: ubuntu-latest
    outputs:
      completed: ${{ steps.evaluate.outputs.completed }}
    steps:
      - uses: actions/checkout@v3
      - uses: actions/setup-node@v4
        with:
          node-version: '20'
      - run: npm install -g @anthropic-ai/claude-code
      
      - name: Download required artifacts
        uses: actions/download-artifact@v4
        with:
          path: ./
      
      - name: Organize downloaded artifacts
        run: |
          mkdir -p "${{ inputs.product_name }}/bulk_scripts" "${{ inputs.product_name }}/personas" "${{ inputs.product_name }}/artifacts" "${{ inputs.product_name }}/evaluations"
          
          # Move scripts from all writers
          for writer in writer1 writer2 writer3; do
            if [ -d "${{ inputs.product_name }}-scripts-${writer}" ]; then
              cp -r "${{ inputs.product_name }}-scripts-${writer}"/* "${{ inputs.product_name }}/bulk_scripts/" 2>/dev/null || true
            fi
          done
          
          # Move personas
          if [ -d "${{ inputs.product_name }}-personas" ]; then
            cp -r "${{ inputs.product_name }}-personas"/* "${{ inputs.product_name }}/personas/" 2>/dev/null || true
          fi
          
          # Move criteria
          if [ -d "${{ inputs.product_name }}-criteria" ]; then
            cp -r "${{ inputs.product_name }}-criteria"/* "${{ inputs.product_name }}/artifacts/" 2>/dev/null || true
          fi
          
          # Move approval threshold (from Phase 2)
          if [ -d "${{ inputs.product_name }}-threshold" ]; then
            cp -r "${{ inputs.product_name }}-threshold"/* "${{ inputs.product_name }}/artifacts/" 2>/dev/null || true
          fi
      
      - id: evaluate
        env:
          ANTHROPIC_API_KEY: ${{ secrets.anthropic_api_key }}
        run: |
          cat << 'EOF' > evaluate_persona3_prompt.txt
          ãƒšãƒ«ã‚½ãƒŠ3ã¨ã—ã¦15æœ¬ã®å°æœ¬ã‚’è©•ä¾¡ã—ã¦ãã ã•ã„ï¼š
          
          ## ã‚ãªãŸã®å½¹å‰²
          {PRODUCT_NAME}/personas/persona3.md ã§å®šç¾©ã•ã‚ŒãŸãƒšãƒ«ã‚½ãƒŠ3ã¨ã—ã¦ã€äººæ ¼å®šç¾©ã‚’èª­ã¿è¾¼ã‚“ã§ã‹ã‚‰è©•ä¾¡ã‚’å®Ÿè¡Œã—ã¦ãã ã•ã„ã€‚
          
          ## è©•ä¾¡å¯¾è±¡
          {PRODUCT_NAME}/bulk_scripts/ ã®å…¨å°æœ¬ï¼ˆ15æœ¬ï¼‰
          
          ## è©•ä¾¡åŸºæº–
          {PRODUCT_NAME}/artifacts/criteria.json ã‹ã‚‰è©•ä¾¡è»¸ã¨é‡ã¿ä»˜ã‘ã‚’å‹•çš„ã«èª­ã¿è¾¼ã¿ã€ãã®åŸºæº–ã«å¾“ã£ã¦è©•ä¾¡ã—ã¦ãã ã•ã„ã€‚
          
          ## è©•ä¾¡ãƒ—ãƒ­ã‚»ã‚¹
          1. ãƒšãƒ«ã‚½ãƒŠ3ã®äººæ ¼å®šç¾©ã‚’ç†è§£
          2. criteria.jsonã®è©•ä¾¡åŸºæº–ã‚’ç¢ºèª
          3. å„å°æœ¬ã‚’è©•ä¾¡åŸºæº–ã«å¾“ã£ã¦æ¡ç‚¹ï¼ˆå„é …ç›®10ç‚¹æº€ç‚¹ï¼‰
          4. é‡ã¿ä»˜ã‘ã‚’é©ç”¨ã—ã¦ç·åˆã‚¹ã‚³ã‚¢ã‚’ç®—å‡º
          
          ## å‡ºåŠ›ãƒ•ã‚¡ã‚¤ãƒ«
          {PRODUCT_NAME}/evaluations/persona3_script_evaluation.json
          
          ## å‡ºåŠ›ãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆ
          ```json
          {
            "evaluator": "persona3",
            "evaluation_date": "YYYY-MM-DD HH:MM:SS",
            "criteria_used": {
              "version": 1,
              "weights": {...}
            },
            "script_evaluations": [
              {
                "script_file": "writer1_target1_script_01.md",
                "writer": "writer1",
                "detailed_scores": {
                  "appeal_direction_clarity": {"score": 8, "feedback": "..."},
                  "differentiation_clarity": {"score": 7, "feedback": "..."},
                  ...
                },
                "weighted_score": 79.5,
                "persona_perspective": "ãƒšãƒ«ã‚½ãƒŠ3ã¨ã—ã¦ã®å…·ä½“çš„ãªæ„Ÿæƒ³ãƒ»è©•ä¾¡ç†ç”±"
              },
              ...
            ],
            "summary": {
              "total_scripts": 15,
              "average_score": 75.2,
              "highest_score": 89.1,
              "lowest_score": 62.3
            }
          }
          ```
          
          ãƒšãƒ«ã‚½ãƒŠ3ã®æ·±å±¤å¿ƒç†ç‰¹æ€§ã‚’åæ˜ ã—ãŸè©•ä¾¡ã‚’è¡Œã£ã¦ãã ã•ã„ã€‚
          EOF
          
          PROMPT=$(cat evaluate_persona3_prompt.txt)
          PROMPT="${PROMPT//\{PRODUCT_NAME\}/${{ inputs.product_name }}}"
          
          echo "ğŸ­ Persona3 evaluating scripts for ${{ inputs.product_name }}..."
          
          npx @anthropic-ai/claude-code \
            --allowedTools "Read,Write" \
            --max-turns 40 \
            --verbose \
            --permission-mode "acceptEdits" \
            -p "$PROMPT"
          
          # å®Œäº†ç¢ºèª
          if [ -f "${{ inputs.product_name }}/evaluations/persona3_script_evaluation.json" ]; then
            echo "completed=true" >> $GITHUB_OUTPUT
            echo "âœ… Persona3 evaluation completed"
          else
            echo "completed=false" >> $GITHUB_OUTPUT
            echo "âŒ Persona3 evaluation failed"
          fi
      
      - name: Upload evaluation artifact
        if: steps.evaluate.outputs.completed == 'true'
        uses: actions/upload-artifact@v4
        with:
          name: ${{ inputs.product_name }}-persona3-script-eval
          path: ${{ inputs.product_name }}/evaluations/persona3_script_evaluation.json
          retention-days: 1

  # Step 2: å¹³å‡å€¤è¨ˆç®—
  calculate-averages:
    needs: [evaluate-persona1, evaluate-persona2, evaluate-persona3]
    runs-on: ubuntu-latest
    outputs:
      completed: ${{ steps.calculate.outputs.completed }}
    steps:
      - uses: actions/checkout@v3
      - run: pip install pandas numpy
      
      - name: Download evaluation artifacts
        uses: actions/download-artifact@v4
        with:
          path: ./
      
      - name: Organize evaluation files
        run: |
          mkdir -p "${{ inputs.product_name }}/evaluations"
          
          # Move persona evaluations
          for i in 1 2 3; do
            if [ -d "${{ inputs.product_name }}-persona${i}-script-eval" ]; then
              cp -r "${{ inputs.product_name }}-persona${i}-script-eval"/* "${{ inputs.product_name }}/evaluations/" 2>/dev/null || true
            fi
          done
      
      - id: calculate
        run: |
          echo "ğŸ“Š Calculating average scores for ${{ inputs.product_name }}..."
          
          python .github/scripts/python/calculate_script_averages.py \
            --product-name "${{ inputs.product_name }}" \
            --input-dir "${{ inputs.product_name }}/evaluations" \
            --output-file "${{ inputs.product_name }}/evaluations/averaged_script_evaluation.json"
          
          # å®Œäº†ç¢ºèª
          if [ -f "${{ inputs.product_name }}/evaluations/averaged_script_evaluation.json" ]; then
            echo "completed=true" >> $GITHUB_OUTPUT
            echo "âœ… Average calculation completed"
          else
            echo "completed=false" >> $GITHUB_OUTPUT
            echo "âŒ Average calculation failed"
          fi
      
      - name: Upload averaged evaluation artifact
        if: steps.calculate.outputs.completed == 'true'
        uses: actions/upload-artifact@v4
        with:
          name: ${{ inputs.product_name }}-averaged-eval
          path: ${{ inputs.product_name }}/evaluations/averaged_script_evaluation.json
          retention-days: 1

  # Step 3: ãƒ•ã‚£ãƒ«ã‚¿ãƒªãƒ³ã‚°åˆ¤å®š
  filter-scripts:
    needs: calculate-averages
    runs-on: ubuntu-latest
    outputs:
      approved_count: ${{ steps.filter.outputs.approved_count }}
      approval_rate: ${{ steps.filter.outputs.approval_rate }}
      writer_adjustment_needed: ${{ steps.filter.outputs.writer_adjustment_needed }}
    steps:
      - uses: actions/checkout@v3
      - run: pip install pandas numpy
      
      - name: Download required artifacts
        uses: actions/download-artifact@v4
        with:
          path: ./
      
      - name: Organize artifacts for filtering
        run: |
          mkdir -p "${{ inputs.product_name }}/evaluations" "${{ inputs.product_name }}/artifacts" "${{ inputs.product_name }}/approved_scripts" "${{ inputs.product_name }}/bulk_scripts"
          
          # Move averaged evaluation
          if [ -d "${{ inputs.product_name }}-averaged-eval" ]; then
            cp -r "${{ inputs.product_name }}-averaged-eval"/* "${{ inputs.product_name }}/evaluations/" 2>/dev/null || true
          fi
          
          # Move threshold from Phase 2
          if [ -d "${{ inputs.product_name }}-threshold" ]; then
            cp -r "${{ inputs.product_name }}-threshold"/* "${{ inputs.product_name }}/artifacts/" 2>/dev/null || true
          fi
          
          # Move scripts for copying approved ones
          for writer in writer1 writer2 writer3; do
            if [ -d "${{ inputs.product_name }}-scripts-${writer}" ]; then
              cp -r "${{ inputs.product_name }}-scripts-${writer}"/* "${{ inputs.product_name }}/bulk_scripts/" 2>/dev/null || true
            fi
          done
      
      - id: filter
        run: |
          echo "ğŸ” Filtering scripts for ${{ inputs.product_name }}..."
          
          python .github/scripts/python/filter_approved_scripts.py \
            --product-name "${{ inputs.product_name }}" \
            --evaluation-file "${{ inputs.product_name }}/evaluations/averaged_script_evaluation.json" \
            --threshold-file "${{ inputs.product_name }}/artifacts/approval_threshold.txt" \
            --output-dir "${{ inputs.product_name }}/approved_scripts" \
            --results-file "${{ inputs.product_name }}/artifacts/filtering_results.json"
          
          # çµæœå‡ºåŠ›
          RESULTS_FILE="${{ inputs.product_name }}/artifacts/filtering_results.json"
          if [ -f "$RESULTS_FILE" ]; then
            APPROVED=$(python -c "import json; data=json.load(open('$RESULTS_FILE')); print(data.get('approved_count', 0))")
            RATE=$(python -c "import json; data=json.load(open('$RESULTS_FILE')); print(data.get('approval_rate', 0))")
            ADJUSTMENT=$(python -c "import json; data=json.load(open('$RESULTS_FILE')); print(str(data.get('writer_adjustment_needed', False)).lower())")
            
            echo "approved_count=$APPROVED" >> $GITHUB_OUTPUT
            echo "approval_rate=$RATE" >> $GITHUB_OUTPUT
            echo "writer_adjustment_needed=$ADJUSTMENT" >> $GITHUB_OUTPUT
            
            echo "âœ… Filtering completed: $APPROVED approved ($RATE%)"
            if [ "$ADJUSTMENT" = "true" ]; then
              echo "âš ï¸ Writer adjustment needed"
            fi
          else
            echo "approved_count=0" >> $GITHUB_OUTPUT
            echo "approval_rate=0" >> $GITHUB_OUTPUT
            echo "writer_adjustment_needed=true" >> $GITHUB_OUTPUT
            echo "âŒ Filtering failed"
          fi
      
      - name: Upload filtering results
        if: steps.filter.outputs.approved_count != ''
        uses: actions/upload-artifact@v4
        with:
          name: ${{ inputs.product_name }}-filtering-results
          path: |
            ${{ inputs.product_name }}/artifacts/filtering_results.json
            ${{ inputs.product_name }}/approved_scripts/
          retention-days: 1

  # Step 4: Writerèª¿æ•´ï¼ˆå¿…è¦æ™‚ã®ã¿ï¼‰
  adjust-writers:
    needs: filter-scripts
    if: needs.filter-scripts.outputs.writer_adjustment_needed == 'true'
    runs-on: ubuntu-latest
    outputs:
      completed: ${{ steps.adjust.outputs.completed }}
    steps:
      - uses: actions/checkout@v3
      - uses: actions/setup-node@v4
        with:
          node-version: '20'
      - run: npm install -g @anthropic-ai/claude-code
      
      - name: Download required artifacts for adjustment
        uses: actions/download-artifact@v4
        with:
          path: ./
      
      - name: Organize artifacts for writer adjustment
        run: |
          mkdir -p "${{ inputs.product_name }}/evaluations" "${{ inputs.product_name }}/artifacts" "${{ inputs.product_name }}/writers"
          
          # Move filtering results
          if [ -d "${{ inputs.product_name }}-filtering-results" ]; then
            cp -r "${{ inputs.product_name }}-filtering-results"/* "${{ inputs.product_name }}/" 2>/dev/null || true
          fi
          
          # Move averaged evaluation
          if [ -d "${{ inputs.product_name }}-averaged-eval" ]; then
            cp -r "${{ inputs.product_name }}-averaged-eval"/* "${{ inputs.product_name }}/evaluations/" 2>/dev/null || true
          fi
          
          # Move existing writers
          if [ -d "${{ inputs.product_name }}-writers" ]; then
            cp -r "${{ inputs.product_name }}-writers"/* "${{ inputs.product_name }}/writers/" 2>/dev/null || true
          fi
      
      - id: adjust
        env:
          ANTHROPIC_API_KEY: ${{ secrets.anthropic_api_key }}
        run: |
          echo "ğŸ”§ Adjusting writer personalities for ${{ inputs.product_name }}..."
          
          # å¤–éƒ¨ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆãƒ•ã‚¡ã‚¤ãƒ«ã®èª­ã¿è¾¼ã¿
          if [ -f ".github/prompts/generation/generate_writers.txt" ]; then
            PROMPT=$(cat .github/prompts/generation/generate_writers.txt)
          else
            echo "::error::Prompt file not found: .github/prompts/generation/generate_writers.txt"
            exit 1
          fi
          
          # Writerèª¿æ•´æŒ‡ç¤ºã‚’è¿½åŠ 
          cat << 'EOF' >> writer_adjustment_instruction.txt
          
          ## Writerèª¿æ•´æŒ‡ç¤º
          
          å‰å›ç”Ÿæˆã•ã‚ŒãŸWriterã®å°æœ¬è©•ä¾¡çµæœã‚’å‚è€ƒã«ã€æ‰¿èªå°æœ¬æ•°ãŒä¸è¶³ã—ã¦ã„ã‚‹Writerã®äººæ ¼ã‚’èª¿æ•´ã—ã¦ãã ã•ã„ï¼š
          
          ### è©•ä¾¡çµæœå‚ç…§
          - {PRODUCT_NAME}/evaluations/averaged_script_evaluation.jsonï¼ˆå¹³å‡è©•ä¾¡çµæœï¼‰
          - {PRODUCT_NAME}/artifacts/filtering_results.jsonï¼ˆãƒ•ã‚£ãƒ«ã‚¿ãƒªãƒ³ã‚°çµæœï¼‰
          
          ### èª¿æ•´æ–¹é‡
          1. **æ‰¿èªå°æœ¬æ•°ãŒ3æœ¬æœªæº€ã®Writer**ã‚’ç‰¹å®š
          2. **è©•ä¾¡ãŒä½ã‹ã£ãŸè¦å› **ã‚’åˆ†æï¼ˆcriteria.jsonã®å„é …ç›®ã‚¹ã‚³ã‚¢ï¼‰
          3. **Writeräººæ ¼ã®å•é¡Œç‚¹**ã‚’ç‰¹å®šï¼ˆã‚­ãƒ£ãƒ©ã‚¯ã‚¿ãƒ¼è¨­å®šãƒ»å£èª¿ãƒ»ã‚¢ãƒ—ãƒ­ãƒ¼ãƒæ–¹æ³•ï¼‰
          4. **ã‚¿ãƒ¼ã‚²ãƒƒãƒˆæ·±å±¤å¿ƒç†ã¨ã®æ•´åˆæ€§**ã‚’å†æ¤œè¨¼
          5. **æ”¹å–„ã•ã‚ŒãŸWriteräººæ ¼**ã‚’å†ç”Ÿæˆ
          
          ### èª¿æ•´å†…å®¹
          - **ã‚­ãƒ£ãƒ©ã‚¯ã‚¿ãƒ¼è¨­å®š**: ã‚ˆã‚Šä¿¡é ¼æ€§ãƒ»å…±æ„Ÿæ€§ã®é«˜ã„äººç‰©åƒ
          - **å£èª¿ãƒ»è¨€è‘‰é£ã„**: ã‚¿ãƒ¼ã‚²ãƒƒãƒˆã«éŸ¿ãè¡¨ç¾æ–¹æ³•
          - **è¨´æ±‚ã‚¢ãƒ—ãƒ­ãƒ¼ãƒ**: æ·±å±¤å¿ƒç†ã«ã‚ˆã‚ŠåŠ¹æœçš„ãªæ‰‹æ³•
          - **æˆ¦ç•¥ãƒ‘ãƒƒã‚±ãƒ¼ã‚¸**: WHO-FMT-USP-ã‚³ãƒ³ã‚»ãƒ—ãƒˆ-ã‚­ãƒ£ãƒƒãƒã‚³ãƒ”ãƒ¼ã®æœ€é©åŒ–
          
          ### å“è³ªå‘ä¸Šè¦ä»¶
          - å‰å›ã®è©•ä¾¡ã§ä½ã‚¹ã‚³ã‚¢ã ã£ãŸé …ç›®ã‚’é‡ç‚¹æ”¹å–„
          - ã‚¿ãƒ¼ã‚²ãƒƒãƒˆã®æœ¬èƒ½ãƒ»ã‚¤ãƒ³ã‚µã‚¤ãƒˆãƒ»èªçŸ¥è»¢æ›ã«ã‚ˆã‚ŠåŠ¹æœçš„ã«ã‚¢ãƒ—ãƒ­ãƒ¼ãƒ
          - ä»–ã®Writerã¨ã®å·®åˆ¥åŒ–ã‚’ç¶­æŒã—ã¤ã¤ã€ç‹¬è‡ªã®å¼·ã¿ã‚’å¼·åŒ–
          
          æ—¢å­˜ã®Writerå®šç¾©ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ä¸Šæ›¸ãã—ã¦ã€æ”¹å–„ã•ã‚ŒãŸWriteräººæ ¼ã‚’ç”Ÿæˆã—ã¦ãã ã•ã„ã€‚
          EOF
          
          ADJUSTMENT_INSTRUCTION=$(cat writer_adjustment_instruction.txt)
          FULL_PROMPT="$PROMPT\n\n$ADJUSTMENT_INSTRUCTION"
          FULL_PROMPT="${FULL_PROMPT//\{PRODUCT_NAME\}/${{ inputs.product_name }}}"
          
          npx @anthropic-ai/claude-code \
            --allowedTools "Read,Write" \
            --max-turns 60 \
            --verbose \
            --permission-mode "acceptEdits" \
            -p "$FULL_PROMPT"
          
          # å®Œäº†ç¢ºèª
          if [ -f "${{ inputs.product_name }}/writers/writer1.md" ] && \
             [ -f "${{ inputs.product_name }}/writers/writer2.md" ] && \
             [ -f "${{ inputs.product_name }}/writers/writer3.md" ]; then
            echo "completed=true" >> $GITHUB_OUTPUT
            echo "âœ… Writer adjustment completed"
          else
            echo "completed=false" >> $GITHUB_OUTPUT
            echo "âŒ Writer adjustment failed"
          fi
      
      - name: Upload adjusted writers
        if: steps.adjust.outputs.completed == 'true'
        uses: actions/upload-artifact@v4
        with:
          name: ${{ inputs.product_name }}-writers-adjusted
          path: ${{ inputs.product_name }}/writers/
          retention-days: 1
