name: 2. è©•ä¾¡åŸºæº–æœ€é©åŒ–ãƒ«ãƒ¼ãƒ—

on:
  workflow_dispatch:
    inputs:
      product_name:
        description: 'å•†å“å'
        required: true
        type: string

permissions:
  contents: write
  pull-requests: write
  actions: write

jobs:
  # Step 1: ãƒ‡ãƒ¼ã‚¿æŠ½å‡ºï¼ˆPythonã‚³ãƒ¼ãƒ‰ï¼‰
  extract_sample_data:
    runs-on: ubuntu-latest
    outputs:
      scripts_extracted: ${{ steps.extract.outputs.scripts_count }}
      extraction_completed: ${{ steps.extract.outputs.completed }}
    steps:
      - uses: actions/checkout@v3
      - uses: actions/setup-python@v4
        with:
          python-version: '3.10'
      - run: pip install pandas numpy
      
      - id: extract
        run: |
          python .github/scripts/python/extract_sample_scripts.py \
            --product-name "${{ inputs.product_name }}" \
            --data-dir "${{ inputs.product_name }}/data" | \
          while read line; do
            echo "$line" >> $GITHUB_OUTPUT
          done
      
      - name: Upload sample scripts artifact
        if: steps.extract.outputs.completed == 'true'
        uses: actions/upload-artifact@v4
        with:
          name: ${{ inputs.product_name }}-sample-scripts
          path: ${{ inputs.product_name }}/artifacts/sample_scripts_for_evaluation.json
          retention-days: 1
      
      - name: Commit sample scripts
        if: steps.extract.outputs.completed == 'true'
        run: |
          git config --global user.name "github-actions[bot]"
          git config --global user.email "github-actions[bot]@users.noreply.github.com"
          git add "${{ inputs.product_name }}/artifacts/sample_scripts_for_evaluation.json"
          git commit -m "ðŸ“Š [${{ inputs.product_name }}] Phase 2: ã‚µãƒ³ãƒ—ãƒ«å°æœ¬æŠ½å‡º" || echo "No changes to commit"
          git push || echo "Nothing to push"

  # Step 2: ãƒšãƒ«ã‚½ãƒŠè©•ä¾¡ï¼ˆä¸¦åˆ—å®Ÿè¡Œï¼‰
  evaluate_persona1:
    needs: extract_sample_data
    if: needs.extract_sample_data.outputs.extraction_completed == 'true'
    uses: ./.github/workflows/module-persona1-evaluation.yml
    with:
      product_name: ${{ inputs.product_name }}
    secrets:
      anthropic_api_key: ${{ secrets.ANTHROPIC_API_KEY }}

  evaluate_persona2:
    needs: extract_sample_data
    if: needs.extract_sample_data.outputs.extraction_completed == 'true'
    uses: ./.github/workflows/module-persona2-evaluation.yml
    with:
      product_name: ${{ inputs.product_name }}
    secrets:
      anthropic_api_key: ${{ secrets.ANTHROPIC_API_KEY }}

  evaluate_persona3:
    needs: extract_sample_data
    if: needs.extract_sample_data.outputs.extraction_completed == 'true'
    uses: ./.github/workflows/module-persona3-evaluation.yml
    with:
      product_name: ${{ inputs.product_name }}
    secrets:
      anthropic_api_key: ${{ secrets.ANTHROPIC_API_KEY }}

  # Step 2.5: ãƒšãƒ«ã‚½ãƒŠè©•ä¾¡å¹³å‡å€¤è¨ˆç®—
  calculate_averages:
    needs: [evaluate_persona1, evaluate_persona2, evaluate_persona3]
    runs-on: ubuntu-latest
    outputs:
      calculation_completed: ${{ steps.calc-averages.outputs.calculation_completed }}
      scripts_processed: ${{ steps.calc-averages.outputs.scripts_processed }}
    steps:
      - uses: actions/checkout@v3
      - uses: actions/setup-python@v4
        with:
          python-version: '3.10'
      - run: pip install pandas numpy

      - name: Download persona evaluation artifacts
        uses: actions/download-artifact@v4
        with:
          path: ./artifacts-temp
      
      - name: Organize evaluation files
        run: |
          mkdir -p "${{ inputs.product_name }}/artifacts"
          
          # Move persona evaluations
          for i in 1 2 3; do
            if [ -d "artifacts-temp/${{ inputs.product_name }}-persona${i}-evaluation" ]; then
              cp -r "artifacts-temp/${{ inputs.product_name }}-persona${i}-evaluation"/* "${{ inputs.product_name }}/artifacts/" 2>/dev/null || true
            fi
          done
      
      - id: calc-averages
        run: |
          python .github/scripts/python/calculate_persona_averages.py \
            --product-name "${{ inputs.product_name }}" | \
          while read line; do
            echo "$line" >> $GITHUB_OUTPUT
          done
      
      - name: Upload averaged evaluation artifact
        if: steps.calc-averages.outputs.calculation_completed == 'true'
        uses: actions/upload-artifact@v4
        with:
          name: ${{ inputs.product_name }}-persona-averages
          path: ${{ inputs.product_name }}/artifacts/persona_evaluation_results.json
          retention-days: 1
      
      - name: Commit persona averages
        if: steps.calc-averages.outputs.calculation_completed == 'true'
        run: |
          git config --global user.name "github-actions[bot]"
          git config --global user.email "github-actions[bot]@users.noreply.github.com"
          
          # ã¾ãšæœ€æ–°ã®çŠ¶æ…‹ã‚’å–å¾—
          git fetch origin main
          git reset --hard origin/main
          
          # å¤‰æ›´ã‚’ã‚¹ãƒ†ãƒ¼ã‚¸ãƒ³ã‚°
          git add "${{ inputs.product_name }}/artifacts/persona_evaluation_results.json"
          
          # ã‚³ãƒŸãƒƒãƒˆ
          git commit -m "ðŸ“Š [${{ inputs.product_name }}] Phase 2: ãƒšãƒ«ã‚½ãƒŠè©•ä¾¡å¹³å‡å€¤è¨ˆç®—å®Œäº†" || echo "No changes to commit"
          
          # push
          git push || echo "Nothing to push"

  # Step 3: ç²¾åº¦ç¢ºèªï¼ˆPythonã‚³ãƒ¼ãƒ‰ï¼‰
  check_precision:
    needs: [extract_sample_data, calculate_averages]
    runs-on: ubuntu-latest
    outputs:
      precision_check: ${{ steps.precision.outputs.precision_check }}
      accuracy_rate: ${{ steps.precision.outputs.accuracy_rate }}
      needs_optimization: ${{ steps.precision.outputs.needs_optimization }}
    steps:
      - uses: actions/checkout@v3
      - uses: actions/setup-python@v4
        with:
          python-version: '3.10'
      - run: pip install pandas numpy
      
      - name: Download persona averages artifact
        uses: actions/download-artifact@v4
        with:
          name: ${{ inputs.product_name }}-persona-averages
          path: ${{ inputs.product_name }}/artifacts/
      
      - name: Download sample scripts artifact
        uses: actions/download-artifact@v4
        with:
          name: ${{ inputs.product_name }}-sample-scripts
          path: ${{ inputs.product_name }}/artifacts/
      
      - id: precision
        run: |
          python .github/scripts/python/check_evaluation_precision.py \
            --product-name "${{ inputs.product_name }}" | \
          while read line; do
            echo "$line" >> $GITHUB_OUTPUT
          done
      
      - name: Upload precision check results
        uses: actions/upload-artifact@v4
        with:
          name: ${{ inputs.product_name }}-precision-check
          path: ${{ inputs.product_name }}/artifacts/precision_check.json
          retention-days: 1

  # Step 4: æ¡ä»¶åˆ†å²ã¨ã‚¢ã‚¯ã‚·ãƒ§ãƒ³ï¼ˆPythonã‚³ãƒ¼ãƒ‰ï¼‰
  execute_next_action:
    needs: [extract_sample_data, calculate_averages, check_precision]
    runs-on: ubuntu-latest
    outputs:
      final_action: ${{ steps.action.outputs.final_action }}
    steps:
      - uses: actions/checkout@v3
      - uses: actions/setup-python@v4
        with:
          python-version: '3.10'
      - run: pip install pandas numpy
      - run: npm install -g @anthropic-ai/claude-code

      - id: action
        env:
          ANTHROPIC_API_KEY: ${{ secrets.ANTHROPIC_API_KEY }}
          GITHUB_TOKEN: ${{ secrets.WORKFLOW_TOKEN }}
        run: |
          # ç²¾åº¦ç¢ºèªçµæžœã«åŸºã¥ãã‚¢ã‚¯ã‚·ãƒ§ãƒ³å®Ÿè¡Œ
          if [ "${{ needs.check_precision.outputs.precision_check }}" = "pass" ]; then
            # ç²¾åº¦é”æˆ: æ‰¿èªé–¾å€¤ã‚’è¨­å®šã—ã¦Phase 3èµ·å‹•
            python .github/scripts/python/execute_next_action.py \
              --product-name "${{ inputs.product_name }}" \
              --precision-check "${{ needs.check_precision.outputs.precision_check }}" \
              --accuracy-rate "${{ needs.check_precision.outputs.accuracy_rate }}" | \
            while read line; do
              echo "$line" >> $GITHUB_OUTPUT
            done
          else
            # ç²¾åº¦ä¸è¶³: è©•ä¾¡åŸºæº–æœ€é©åŒ–
            echo "âš ï¸ ç²¾åº¦ãŒä¸è¶³ã—ã¦ã„ã¾ã™ã€‚è©•ä¾¡åŸºæº–ã‚’æœ€é©åŒ–ã—ã¾ã™..."
            
            # å¤–éƒ¨ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆãƒ•ã‚¡ã‚¤ãƒ«ã‚’èª­ã¿è¾¼ã¿
            if [ -f ".github/prompts/optimization/optimize_criteria.txt" ]; then
              PROMPT=$(cat .github/prompts/optimization/optimize_criteria.txt)
            else
              echo "::error::Prompt file not found: .github/prompts/optimization/optimize_criteria.txt"
              exit 1
            fi
            
            # ãƒ—ãƒ¬ãƒ¼ã‚¹ãƒ›ãƒ«ãƒ€ãƒ¼ã‚’ç½®æ›
            PROMPT="${PROMPT//\{PRODUCT_NAME\}/${{ inputs.product_name }}}"
            PROMPT="${PROMPT//\{LOOP_NUMBER\}/2}"  # Phase 2ãªã®ã§2ã‚’è¨­å®š
            
            npx @anthropic-ai/claude-code \
              --allowedTools "Read,Write" \
              --max-turns 30 \
              --verbose \
              --permission-mode "acceptEdits" \
              -p "$PROMPT"
            
            # Phase 2ã‚’å†å®Ÿè¡Œ
            echo "ðŸ”„ Phase 2ã‚’å†å®Ÿè¡Œã—ã¾ã™..."
            gh workflow run 2-criteria-optimization.yml -f product_name=${{ inputs.product_name }}
            
            echo "final_action=phase2_rerun" >> $GITHUB_OUTPUT
          fi
      
      - name: Upload threshold if set
        if: needs.check_precision.outputs.precision_check == 'pass'
        uses: actions/upload-artifact@v4
        with:
          name: ${{ inputs.product_name }}-threshold
          path: ${{ inputs.product_name }}/artifacts/approval_threshold.txt
          retention-days: 1
      
      - name: Commit threshold to repository
        if: needs.check_precision.outputs.precision_check == 'pass'
        run: |
          echo "ðŸ’¾ Committing approval threshold..."
          
          git config --global user.name "github-actions[bot]"
          git config --global user.email "github-actions[bot]@users.noreply.github.com"
          
          # Add threshold file
          git add "${{ inputs.product_name }}/artifacts/approval_threshold.txt" || true
          
          # Commit
          git commit -m "ðŸ“Š [${{ inputs.product_name }}] Phase 2: æ‰¿èªé–¾å€¤ã‚’è¨­å®š" || {
            echo "No changes to commit"
          }
          
          # Push to repository
          git push || {
            echo "Nothing to push"
          }
          
          echo "âœ… Approval threshold committed to repository"
      
      - name: Upload updated criteria if optimized
        if: needs.check_precision.outputs.precision_check != 'pass'
        uses: actions/upload-artifact@v4
        with:
          name: ${{ inputs.product_name }}-criteria
          path: ${{ inputs.product_name }}/artifacts/criteria.json
          retention-days: 1

  # Step 5: çµæžœé›†è¨ˆ
  finalize:
    needs: [extract_sample_data, calculate_averages, check_precision, execute_next_action]
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v3
      
      - name: Commit Results
        run: |
          git config --global user.name "github-actions[bot]"
          git config --global user.email "github-actions[bot]@users.noreply.github.com"
          git add -A
          git commit -m "ðŸ“Š [${{ inputs.product_name }}] Phase 2: è©•ä¾¡åŸºæº–æœ€é©åŒ–å®Ÿè¡Œ" || {
            echo "No changes to commit"
          }
          git push || {
            echo "Nothing to push"
          }
      
      - name: Generate Summary
        run: |
          echo "## ðŸ“Š Phase 2 å®Œäº†: è©•ä¾¡åŸºæº–æœ€é©åŒ–" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### ðŸ“ˆ å®Ÿè¡Œçµæžœ" >> $GITHUB_STEP_SUMMARY
          echo "- æŠ½å‡ºå°æœ¬æ•°: ${{ needs.extract_sample_data.outputs.scripts_extracted }}æœ¬" >> $GITHUB_STEP_SUMMARY
          echo "- ãƒšãƒ«ã‚½ãƒŠè©•ä¾¡: 3ã¤ã®ãƒšãƒ«ã‚½ãƒŠã§ä¸¦åˆ—å®Ÿè¡Œå®Œäº†" >> $GITHUB_STEP_SUMMARY
          echo "- å¹³å‡å€¤è¨ˆç®—: ${{ needs.calculate_averages.outputs.scripts_processed }}æœ¬å‡¦ç†" >> $GITHUB_STEP_SUMMARY
          echo "- ç²¾åº¦ç¢ºèª: ${{ needs.check_precision.outputs.accuracy_rate }}%" >> $GITHUB_STEP_SUMMARY
          echo "- æœ€é©åŒ–å¿…è¦: ${{ needs.check_precision.outputs.needs_optimization }}" >> $GITHUB_STEP_SUMMARY
          echo "- å®Ÿè¡Œã‚¢ã‚¯ã‚·ãƒ§ãƒ³: ${{ needs.execute_next_action.outputs.final_action }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          if [ "${{ needs.execute_next_action.outputs.final_action }}" = "phase3_triggered" ]; then
            echo "### ðŸš€ æ¬¡ã®ã‚¹ãƒ†ãƒƒãƒ—" >> $GITHUB_STEP_SUMMARY
            echo "âœ… ç²¾åº¦è¦ä»¶ã‚’æº€ãŸã—ã¾ã—ãŸã€‚Phase 3ï¼ˆå°æœ¬ç”Ÿæˆï¼‰ãŒè‡ªå‹•èµ·å‹•ã•ã‚Œã¾ã—ãŸã€‚" >> $GITHUB_STEP_SUMMARY
          elif [ "${{ needs.execute_next_action.outputs.final_action }}" = "phase2_rerun" ]; then
            echo "### ðŸ”„ ç¶™ç¶šå®Ÿè¡Œ" >> $GITHUB_STEP_SUMMARY
            echo "âš ï¸ ç²¾åº¦ãŒä¸è¶³ã—ã¦ã„ã¾ã™ã€‚è©•ä¾¡åŸºæº–ã‚’æœ€é©åŒ–ã—ã¦Phase 2ã‚’å†å®Ÿè¡Œã—ã¾ã—ãŸã€‚" >> $GITHUB_STEP_SUMMARY
          fi