name: 2. 評価基準最適化ループ

on:
  workflow_dispatch:
    inputs:
      product_name:
        description: '商品名'
        required: true
        type: string

permissions:
  contents: write
  pull-requests: write
  actions: write

jobs:
  # Step 1: データ抽出（Pythonコード）
  extract_sample_data:
    runs-on: ubuntu-latest
    outputs:
      scripts_extracted: ${{ steps.extract.outputs.scripts_count }}
      extraction_completed: ${{ steps.extract.outputs.completed }}
    steps:
      - uses: actions/checkout@v3
      - uses: actions/setup-python@v4
        with:
          python-version: '3.10'
      - run: pip install pandas numpy

      - name: Download data artifacts
        uses: actions/download-artifact@v4
        with:
          path: ./
      
      - name: Organize data files
        run: |
          mkdir -p "${{ inputs.product_name }}/data" "${{ inputs.product_name }}/artifacts"
          
          # Move data files
          if [ -d "${{ inputs.product_name }}-data" ]; then
            cp -r "${{ inputs.product_name }}-data"/* "${{ inputs.product_name }}/data/" 2>/dev/null || true
          fi
      
      - id: extract
        run: |
          python .github/scripts/python/extract_sample_scripts.py \
            --product-name "${{ inputs.product_name }}" \
            --data-dir "${{ inputs.product_name }}/data" | \
          while read line; do
            echo "$line" >> $GITHUB_OUTPUT
          done
      
      - name: Upload sample scripts artifact
        if: steps.extract.outputs.completed == 'true'
        uses: actions/upload-artifact@v4
        with:
          name: ${{ inputs.product_name }}-sample-scripts
          path: ${{ inputs.product_name }}/artifacts/sample_scripts_for_evaluation.json
          retention-days: 1

  # Step 2: ペルソナ評価（並列実行）
  evaluate_persona1:
    needs: extract_sample_data
    if: needs.extract_sample_data.outputs.extraction_completed == 'true'
    uses: ./.github/workflows/module-persona1-evaluation.yml
    with:
      product_name: ${{ inputs.product_name }}
    secrets:
      anthropic_api_key: ${{ secrets.ANTHROPIC_API_KEY }}

  evaluate_persona2:
    needs: extract_sample_data
    if: needs.extract_sample_data.outputs.extraction_completed == 'true'
    uses: ./.github/workflows/module-persona2-evaluation.yml
    with:
      product_name: ${{ inputs.product_name }}
    secrets:
      anthropic_api_key: ${{ secrets.ANTHROPIC_API_KEY }}

  evaluate_persona3:
    needs: extract_sample_data
    if: needs.extract_sample_data.outputs.extraction_completed == 'true'
    uses: ./.github/workflows/module-persona3-evaluation.yml
    with:
      product_name: ${{ inputs.product_name }}
    secrets:
      anthropic_api_key: ${{ secrets.ANTHROPIC_API_KEY }}

  # Step 2.5: ペルソナ評価平均値計算
  calculate_averages:
    needs: [evaluate_persona1, evaluate_persona2, evaluate_persona3]
    runs-on: ubuntu-latest
    outputs:
      calculation_completed: ${{ steps.calc-averages.outputs.calculation_completed }}
      scripts_processed: ${{ steps.calc-averages.outputs.scripts_processed }}
    steps:
      - uses: actions/checkout@v3
      - uses: actions/setup-python@v4
        with:
          python-version: '3.10'
      - run: pip install pandas numpy

      - name: Download persona evaluation artifacts
        uses: actions/download-artifact@v4
        with:
          path: ./
      
      - name: Organize evaluation files
        run: |
          mkdir -p "${{ inputs.product_name }}/artifacts"
          
          # Move persona evaluations
          for i in 1 2 3; do
            if [ -d "${{ inputs.product_name }}-persona${i}-evaluation" ]; then
              cp -r "${{ inputs.product_name }}-persona${i}-evaluation"/* "${{ inputs.product_name }}/artifacts/" 2>/dev/null || true
            fi
          done
      
      - id: calc-averages
        run: |
          python .github/scripts/python/calculate_persona_averages.py \
            --product-name "${{ inputs.product_name }}" | \
          while read line; do
            echo "$line" >> $GITHUB_OUTPUT
          done
      
      - name: Upload averaged evaluation artifact
        if: steps.calc-averages.outputs.calculation_completed == 'true'
        uses: actions/upload-artifact@v4
        with:
          name: ${{ inputs.product_name }}-persona-averages
          path: ${{ inputs.product_name }}/artifacts/persona_evaluation_results.json
          retention-days: 1

  # Step 3: 精度確認（Pythonコード）
  check_precision:
    needs: [extract_sample_data, calculate_averages]
    runs-on: ubuntu-latest
    outputs:
      precision_check: ${{ steps.precision.outputs.precision_check }}
      accuracy_rate: ${{ steps.precision.outputs.accuracy_rate }}
      needs_optimization: ${{ steps.precision.outputs.needs_optimization }}
    steps:
      - uses: actions/checkout@v3
      - uses: actions/setup-python@v4
        with:
          python-version: '3.10'
      - run: pip install pandas numpy

      - name: Download required artifacts
        uses: actions/download-artifact@v4
        with:
          path: ./
      
      - name: Organize files for precision check
        run: |
          mkdir -p "${{ inputs.product_name }}/artifacts" "${{ inputs.product_name }}/data"
          
          # Move sample scripts
          if [ -d "${{ inputs.product_name }}-sample-scripts" ]; then
            cp -r "${{ inputs.product_name }}-sample-scripts"/* "${{ inputs.product_name }}/artifacts/" 2>/dev/null || true
          fi
          
          # Move persona averages
          if [ -d "${{ inputs.product_name }}-persona-averages" ]; then
            cp -r "${{ inputs.product_name }}-persona-averages"/* "${{ inputs.product_name }}/artifacts/" 2>/dev/null || true
          fi
          
          # Move data files
          if [ -d "${{ inputs.product_name }}-data" ]; then
            cp -r "${{ inputs.product_name }}-data"/* "${{ inputs.product_name }}/data/" 2>/dev/null || true
          fi
      
      - id: precision
        run: |
          python .github/scripts/python/check_evaluation_precision.py \
            --product-name "${{ inputs.product_name }}" | \
          while read line; do
            echo "$line" >> $GITHUB_OUTPUT
          done
      
      - name: Upload precision check results
        uses: actions/upload-artifact@v4
        with:
          name: ${{ inputs.product_name }}-precision-check
          path: ${{ inputs.product_name }}/artifacts/precision_check.json
          retention-days: 1

  # Step 4: 条件分岐とアクション（Pythonコード）
  execute_next_action:
    needs: [extract_sample_data, calculate_averages, check_precision]
    runs-on: ubuntu-latest
    outputs:
      final_action: ${{ steps.action.outputs.final_action }}
    steps:
      - uses: actions/checkout@v3
      - uses: actions/setup-python@v4
        with:
          python-version: '3.10'
      - run: pip install pandas numpy
      - run: npm install -g @anthropic-ai/claude-code
      
      - name: Download all required artifacts
        uses: actions/download-artifact@v4
        with:
          path: ./
      
      - name: Organize all artifacts
        run: |
          mkdir -p "${{ inputs.product_name }}/artifacts" "${{ inputs.product_name }}/data"
          
          # Move precision check results
          if [ -d "${{ inputs.product_name }}-precision-check" ]; then
            cp -r "${{ inputs.product_name }}-precision-check"/* "${{ inputs.product_name }}/artifacts/" 2>/dev/null || true
          fi
          
          # Move persona averages
          if [ -d "${{ inputs.product_name }}-persona-averages" ]; then
            cp -r "${{ inputs.product_name }}-persona-averages"/* "${{ inputs.product_name }}/artifacts/" 2>/dev/null || true
          fi
          
          # Move criteria
          if [ -d "${{ inputs.product_name }}-criteria" ]; then
            cp -r "${{ inputs.product_name }}-criteria"/* "${{ inputs.product_name }}/artifacts/" 2>/dev/null || true
          fi

      - id: action
        env:
          ANTHROPIC_API_KEY: ${{ secrets.ANTHROPIC_API_KEY }}
          GITHUB_TOKEN: ${{ secrets.WORKFLOW_TOKEN }}
        run: |
          # 精度確認結果に基づくアクション実行
          if [ "${{ needs.check_precision.outputs.precision_check }}" = "pass" ]; then
            # 精度達成: 承認閾値を設定してPhase 3起動
            python .github/scripts/python/execute_next_action.py \
              --product-name "${{ inputs.product_name }}" \
              --precision-check "${{ needs.check_precision.outputs.precision_check }}" \
              --accuracy-rate "${{ needs.check_precision.outputs.accuracy_rate }}" | \
            while read line; do
              echo "$line" >> $GITHUB_OUTPUT
            done
          else
            # 精度不足: 評価基準最適化
            echo "⚠️ 精度が不足しています。評価基準を最適化します..."
            
            # Claude Code SDKで評価基準最適化
            cat << 'EOF' > optimize_criteria_prompt.txt
            評価基準の最適化を実行してください：
            
            ## 現状分析
            {PRODUCT_NAME}/artifacts/precision_check.json の結果を詳細分析し、
            精度向上のために {PRODUCT_NAME}/artifacts/criteria.json の重み付けを最適化してください。
            
            ## 最適化要件
            - 目標精度: 80%以上
            - 各グループで3本以上の差分をなくす
            - version番号をインクリメント
            - 変更理由をdescriptionに記録
            
            ## 出力
            最適化された criteria.json を保存してください。
            EOF
            
            PROMPT=$(cat optimize_criteria_prompt.txt)
            PROMPT="${PROMPT//\{PRODUCT_NAME\}/${{ inputs.product_name }}}"
            
            npx @anthropic-ai/claude-code \
              --allowedTools "Read,Write" \
              --max-turns 30 \
              --verbose \
              --permission-mode "acceptEdits" \
              -p "$PROMPT"
            
            # Phase 2を再実行
            echo "🔄 Phase 2を再実行します..."
            gh workflow run 2-criteria-optimization.yml -f product_name=${{ inputs.product_name }}
            
            echo "final_action=phase2_rerun" >> $GITHUB_OUTPUT
          fi
      
      - name: Upload threshold if set
        if: needs.check_precision.outputs.precision_check == 'pass'
        uses: actions/upload-artifact@v4
        with:
          name: ${{ inputs.product_name }}-threshold
          path: ${{ inputs.product_name }}/artifacts/approval_threshold.txt
          retention-days: 1
      
      - name: Upload updated criteria if optimized
        if: needs.check_precision.outputs.precision_check != 'pass'
        uses: actions/upload-artifact@v4
        with:
          name: ${{ inputs.product_name }}-criteria
          path: ${{ inputs.product_name }}/artifacts/criteria.json
          retention-days: 1

  # Step 5: 結果集計
  finalize:
    needs: [extract_sample_data, calculate_averages, check_precision, execute_next_action]
    runs-on: ubuntu-latest
    steps:
      - name: Commit Results
        run: |
          git config --global user.name "github-actions[bot]"
          git config --global user.email "github-actions[bot]@users.noreply.github.com"
          git add -A
          git commit -m "📊 [${{ inputs.product_name }}] Phase 2: 評価基準最適化実行" || {
            echo "No changes to commit"
          }
          git push || {
            echo "Nothing to push"
          }
      
      - name: Generate Summary
        run: |
          echo "## 📊 Phase 2 完了: 評価基準最適化" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### 📈 実行結果" >> $GITHUB_STEP_SUMMARY
          echo "- 抽出台本数: ${{ needs.extract_sample_data.outputs.scripts_extracted }}本" >> $GITHUB_STEP_SUMMARY
          echo "- ペルソナ評価: 3つのペルソナで並列実行完了" >> $GITHUB_STEP_SUMMARY
          echo "- 平均値計算: ${{ needs.calculate_averages.outputs.scripts_processed }}本処理" >> $GITHUB_STEP_SUMMARY
          echo "- 精度確認: ${{ needs.check_precision.outputs.accuracy_rate }}%" >> $GITHUB_STEP_SUMMARY
          echo "- 最適化必要: ${{ needs.check_precision.outputs.needs_optimization }}" >> $GITHUB_STEP_SUMMARY
          echo "- 実行アクション: ${{ needs.execute_next_action.outputs.final_action }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          if [ "${{ needs.execute_next_action.outputs.final_action }}" = "phase3_triggered" ]; then
            echo "### 🚀 次のステップ" >> $GITHUB_STEP_SUMMARY
            echo "✅ 精度要件を満たしました。Phase 3（台本生成）が自動起動されました。" >> $GITHUB_STEP_SUMMARY
          elif [ "${{ needs.execute_next_action.outputs.final_action }}" = "phase2_rerun" ]; then
            echo "### 🔄 継続実行" >> $GITHUB_STEP_SUMMARY
            echo "⚠️ 精度が不足しています。評価基準を最適化してPhase 2を再実行しました。" >> $GITHUB_STEP_SUMMARY
          fi