name: module-generate-writers

on:
  workflow_call:
    inputs:
      product_name:
        description: 'ÂïÜÂìÅÂêç'
        required: true
        type: string
    outputs:
      writers_generated:
        description: 'ÁîüÊàê„Åï„Çå„Åü„É©„Ç§„Çø„ÉºÊï∞'
        value: ${{ jobs.generate.outputs.writers_generated }}
      completed:
        description: 'ÂÆå‰∫Ü„Çπ„ÉÜ„Éº„Çø„Çπ'
        value: ${{ jobs.generate.outputs.completed }}
    secrets:
      anthropic_api_key:
        description: 'Anthropic API Key'
        required: true

jobs:
  generate:
    runs-on: ubuntu-latest
    outputs:
      writers_generated: ${{ steps.generate-writers.outputs.count }}
      completed: ${{ steps.generate-writers.outputs.completed }}
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v3
      
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
      
      - name: Install Claude Code SDK
        run: npm install -g @anthropic-ai/claude-code
      
      - name: Create writers directory
        run: |
          mkdir -p "${{ inputs.product_name }}/writers"
          echo "‚úÖ Created writers directory: ${{ inputs.product_name }}/writers"
      
      - name: Generate Writers with Claude Code SDK
        id: generate-writers
        env:
          ANTHROPIC_API_KEY: ${{ secrets.anthropic_api_key }}
        run: |
          echo "::group::‚úçÔ∏è Generating writers for ${{ inputs.product_name }}"
          
          # „Éó„É≠„É≥„Éó„Éà„ÇíÂ§ñÈÉ®„Éï„Ç°„Ç§„É´„Åã„ÇâË™≠„ÅøËæº„Åø
          if [ -f ".github/prompts/generation/generate_writers.txt" ]; then
            PROMPT_TEMPLATE=$(cat .github/prompts/generation/generate_writers.txt)
          else
            echo "‚ö†Ô∏è Prompt file not found, using inline prompt"
            PROMPT_TEMPLATE="ÂàÜÊûê„É¨„Éù„Éº„Éà„ÇíÂü∫„Å´„ÄÅÂïÜÂìÅ„Äå{PRODUCT_NAME}„Äç„ÅÆÂ∫ÉÂëäÂè∞Êú¨„Çí‰ΩúÊàê„Åô„Çã„É©„Ç§„Çø„Éº‰∫∫Ê†º„Çí3„Å§ÁîüÊàê„Åó„Å¶„Åè„Å†„Åï„ÅÑ„ÄÇ
            
            ÂÖ•Âäõ:
            - {PRODUCT_NAME}/artifacts/product_analysis.md
            - {PRODUCT_NAME}/artifacts/market_analysis.md
            
            ÁîüÊàê„Åô„Çã„Éï„Ç°„Ç§„É´:
            
            „Äê„É©„Ç§„Çø„Éº3Âêç„Äë{PRODUCT_NAME}/writers/
            - writer1.md: ÊÑüÊÉÖË®¥Ê±ÇÂûãÔºà„Çπ„Éà„Éº„É™„Éº„ÉÜ„É™„É≥„Ç∞ÈáçË¶ñÔºâ
            - writer2.md: Ë´ñÁêÜË®¥Ê±ÇÂûãÔºà„Éá„Éº„Çø„Å®Ë´ñÁêÜÈáçË¶ñÔºâ
            - writer3.md: „Éè„Ç§„Éñ„É™„ÉÉ„ÉâÂûãÔºà„Ç®„É≥„Çø„É°„Å®ÂÆüÁî®ÊÄßÔºâ
            
            ÂêÑ„É©„Ç§„Çø„Éº„Å´„ÅØ‰ª•‰∏ã„ÇíÂê´„ÇÅ„Çã:
            - „ÇØ„É™„Ç®„Ç§„ÉÜ„Ç£„ÉñÂì≤Â≠¶
            - „É°„ÉÉ„Çª„Éº„Ç∏Êà¶Áï•
            - Ë°®Áèæ„Çπ„Çø„Ç§„É´
            - Âà∂‰Ωú„Ç¨„Ç§„Éâ„É©„Ç§„É≥
            
            Ë©≥Á¥∞„ÅßÂÆüË∑µÁöÑ„Å™‰∫∫Ê†ºÂÆöÁæ©„Çí‰ΩúÊàê„Åó„Å¶„Åè„Å†„Åï„ÅÑ„ÄÇ"
          fi
          
          # „Éó„É¨„Éº„Çπ„Éõ„É´„ÉÄ„Éº„ÇíÁΩÆÊèõ
          PROMPT="${PROMPT_TEMPLATE//\{PRODUCT_NAME\}/${{ inputs.product_name }}}"
          
          echo "üìù Executing Claude Code SDK for writer generation..."
          
          # Claude Code SDK„ÅÆÂÆüË°å
          npx @anthropic-ai/claude-code \
            --allowedTools "Read,Write" \
            --max-turns 40 \
            --verbose \
            --permission-mode "acceptEdits" \
            -p "$PROMPT" || {
              echo "::error::‚ùå Claude Code SDK execution failed"
              exit 1
            }
          
          # ÁîüÊàê„Åï„Çå„Åü„É©„Ç§„Çø„ÉºÊï∞„Çí„Ç´„Ç¶„É≥„Éà
          echo ""
          echo "üìÇ Checking generated writers..."
          if [ -d "${{ inputs.product_name }}/writers" ]; then
            WRITER_COUNT=$(ls -1 "${{ inputs.product_name }}/writers/"*.md 2>/dev/null | wc -l)
            echo "::notice::‚úÖ Generated $WRITER_COUNT writers"
            ls -la "${{ inputs.product_name }}/writers/"
            
            if [ "$WRITER_COUNT" -gt 0 ]; then
              echo "count=$WRITER_COUNT" >> $GITHUB_OUTPUT
              echo "completed=true" >> $GITHUB_OUTPUT
            else
              echo "::error::‚ùå No writers were generated"
              exit 1
            fi
          else
            echo "::error::‚ùå Writers directory not found"
            exit 1
          fi
          
          echo "::endgroup::"